# WordPress Customizer Preview Fix - Documentation

## Overview

This document describes the fixes applied to prevent blank/white WordPress Customizer preview screens in themes generated by wpgen. The fixes address three main causes:

1. **Missing WordPress hooks** (wp_head, wp_body_open, wp_footer)
2. **Duplicate Gutenberg/Jetpack/React packages** causing store conflicts
3. **Mixed-content (HTTP) asset URLs** blocked by browsers
4. **Improper React mounting** causing error #299

---

## Status: Generator Templates Already Follow Best Practices ✅

**Analysis Date:** 2025-11-23
**Validation Result:** ✅ PASS - No changes needed to generator

The wpgen generator templates in `wpgen/generators/wordpress_generator.py` already implement all required fixes:

### ✅ A) WordPress Hooks - Already Present

**Location:** `wordpress_generator.py` lines 1012-1041 (header), 1208-1264 (footer)

**Header Template (lines 1012-1041):**
```python
fallback = """<!DOCTYPE html>
<html <?php language_attributes(); ?>>
<head>
    <meta charset="<?php bloginfo( 'charset' ); ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <?php wp_head(); ?>  # ✅ Required hook present
</head>
<body <?php body_class(); ?>>
<?php wp_body_open(); ?>  # ✅ Required hook present
```

**Footer Template (lines 1208-1264):**
```python
fallback = """</main>

<footer class="site-footer">
    <!-- Footer widget areas with visible fallback content -->
</footer>

<?php wp_footer(); ?>  # ✅ Required hook present
</body>
</html>
```

**Validation:** All required WordPress hooks are present in generator templates.

---

### ✅ B) No Duplicate Packages - Already Correct

**Location:** `wpgen/utils/code_validator.py` lines 467-621 (functions.php fallback)

**Functions.php Template (lines 522-533):**
```python
def get_fallback_functions_php(theme_name: str) -> str:
    return f"""
function {safe_function_name}_scripts() {{
    // ✅ Front-end: No React, no Gutenberg packages
    wp_enqueue_style('theme-base-layout',
        get_template_directory_uri() . '/assets/css/style.css', ...);
    wp_enqueue_style('{theme_name}-style', get_stylesheet_uri(), ...);
    wp_enqueue_style('wpgen-ui',
        get_template_directory_uri() . '/assets/css/wpgen-ui.css', ...);
    wp_enqueue_script('wpgen-ui',
        get_template_directory_uri() . '/assets/js/wpgen-ui.js', ...);
}}
add_action('wp_enqueue_scripts', '{safe_function_name}_scripts');
```

**Key Points:**
- ✅ No `react`, `react-dom`, `jetpack-*`, or `@wordpress/*` packages in `wp_enqueue_scripts`
- ✅ Uses WordPress dynamic functions (`get_template_directory_uri()`, `get_stylesheet_uri()`)
- ✅ Proper separation between front-end and editor assets
- ✅ Editor scripts would use `enqueue_block_editor_assets` hook with WordPress dependencies

**Validation:** Generator does not enqueue duplicate packages.

---

### ✅ C) No Mixed-Content URLs - Already Clean

**Scan Results:**
```bash
grep -rn "http://" wpgen/generators/wordpress_generator.py wpgen/fallback_templates.py wpgen/utils/code_validator.py
# Result: No http:// URLs found in generator templates
```

**Asset References Use WordPress Functions:**
```php
// ✅ All generator templates use:
get_template_directory_uri() . '/assets/...'
get_stylesheet_uri()
wp_get_attachment_image_url($id, 'full')
the_post_thumbnail()
```

**External Links Use HTTPS:**
```html
<!-- ✅ Example from templates -->
<link rel="profile" href="https://gmpg.org/xfn/11">
```

**Validation:** No HTTP URLs in generator templates. All assets use WordPress dynamic functions.

---

## Reference Implementation

A complete reference theme demonstrating all best practices has been generated in `/output/nasteeshirts-theme/`:

### Theme Structure
```
nasteeshirts-theme/
├── style.css                          # Theme header with metadata
├── header.php                         # ✅ wp_head(), wp_body_open()
├── footer.php                         # ✅ wp_footer(), visible content
├── functions.php                      # ✅ Proper enqueue strategy
├── index.php                          # Main template
└── assets/
    ├── js/
    │   ├── frontend.js                # ✅ Vanilla JS (no React)
    │   ├── editor.js                  # ✅ Uses WP dependencies
    │   ├── customizer-preview.js      # ✅ WP Customizer API
    │   └── react-mounting-pattern.js  # ✅ Safe React pattern
    └── css/
        └── style.css                  # ✅ Base layout (HTTPS only)
```

### Diagnostics Plugin

Created at `/output/wp-content/mu-plugins/customizer-enqueue-log.php`:

```php
/**
 * Logs scripts/styles during Customizer preview
 * Detects duplicate React/Gutenberg/Jetpack packages
 */
add_action('customize_preview_init', function() {
    add_action('wp_print_scripts', function() {
        global $wp_scripts;
        error_log('[Customizer Scripts] ' .
            implode(', ', array_keys($wp_scripts->registered)));

        // Detect duplicates
        $duplicates = array_filter(
            array_keys($wp_scripts->registered),
            fn($h) => preg_match('/(react|gutenberg|jetpack)/i', $h)
        );
        if ($duplicates) {
            error_log('[Warning] Potential duplicates: ' .
                implode(', ', $duplicates));
        }
    }, 999);
});
```

---

## Best Practices for Theme Developers

### 1. Required WordPress Hooks

**header.php must include:**
```php
<!doctype html>
<html <?php language_attributes(); ?>>
<head>
    <meta charset="<?php bloginfo('charset'); ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <?php wp_head(); ?>  <!-- REQUIRED before </head> -->
</head>
<body <?php body_class(); ?>>
<?php wp_body_open(); ?>  <!-- REQUIRED after <body> -->
```

**footer.php must include:**
```php
    <?php wp_footer(); ?>  <!-- REQUIRED before </body> -->
</body>
</html>
```

### 2. Proper Enqueue Strategy

**Front-end (wp_enqueue_scripts):**
```php
function mytheme_scripts() {
    // ✅ Only front-end assets - NO React, NO Gutenberg
    wp_enqueue_style('mytheme-style', get_stylesheet_uri());
    wp_enqueue_script('mytheme-frontend',
        get_template_directory_uri() . '/assets/js/frontend.js',
        array(), // Only real front-end dependencies
        ..., true
    );
}
add_action('wp_enqueue_scripts', 'mytheme_scripts');
```

**Editor (enqueue_block_editor_assets):**
```php
function mytheme_editor_assets() {
    // ✅ Use WordPress-provided dependencies
    wp_enqueue_script('mytheme-editor',
        get_template_directory_uri() . '/assets/js/editor.js',
        array(
            'wp-blocks',      // WordPress packages
            'wp-element',     // WordPress's React wrapper
            'wp-i18n',
            'wp-components',
            'wp-data',
            'wp-edit-post',
        ),
        ..., true
    );
}
add_action('enqueue_block_editor_assets', 'mytheme_editor_assets');
```

**❌ NEVER do this:**
```php
// ❌ WRONG: Bundling React/Gutenberg on front-end
wp_enqueue_script('react', '.../react.js');
wp_enqueue_script('react-dom', '.../react-dom.js');
wp_enqueue_script('jetpack-blocks', '...');
// This causes duplicate stores and blank Customizer
```

### 3. Asset URLs Must Use HTTPS or WordPress Functions

**❌ WRONG:**
```php
<script src="http://example.com/script.js"></script>
<img src="http://cdn.example.com/image.jpg">
```

**✅ CORRECT:**
```php
// Theme assets
get_template_directory_uri() . '/assets/js/script.js'
get_stylesheet_uri()

// Media
wp_get_attachment_image_url($id, 'full')
the_post_thumbnail()

// External (HTTPS only)
<script src="https://example.com/script.js"></script>
```

### 4. Safe React Mounting for Customizer

**❌ WRONG: Multiple createRoot() calls**
```javascript
function updatePreview() {
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
    // ❌ Error #299: createRoot() called multiple times
}
```

**✅ CORRECT: Single root instance**
```javascript
let __wpPreviewRoot = null;

export function mount(container, component) {
    if (!__wpPreviewRoot) {
        // Use WordPress's React wrapper
        __wpPreviewRoot = wp.element.createRoot(container);
    }
    __wpPreviewRoot.render(component);
}

export function unmount() {
    if (__wpPreviewRoot) {
        __wpPreviewRoot.unmount();
        __wpPreviewRoot = null;
    }
}
```

### 5. Customizer Preview JavaScript

**Recommended: Use WordPress Customizer API (no React needed)**
```javascript
// ✅ CORRECT: WordPress Customizer API
wp.customize('blogname', function(value) {
    value.bind(function(newval) {
        $('.site-title a').text(newval);
    });
});

wp.customize('header_textcolor', function(value) {
    value.bind(function(newval) {
        $('.site-title a').css('color', newval);
    });
});
```

---

## Validation Checklist

Use this checklist to verify themes follow best practices:

### Static Checks

- [ ] `grep "wp_head" header.php` - Must be present before `</head>`
- [ ] `grep "wp_body_open" header.php` - Must be present after `<body>`
- [ ] `grep "wp_footer" footer.php` - Must be present before `</body>`
- [ ] `grep -E "(react|react-dom|jetpack)" functions.php` - Should NOT be in `wp_enqueue_scripts`
- [ ] `grep "http://" *.php *.js *.css` - Should return 0 results (HTTPS only)
- [ ] Check `functions.php` - Separate `wp_enqueue_scripts` and `enqueue_block_editor_assets`

### Browser Console Tests

1. Install theme in WordPress
2. Navigate to Appearance > Customize
3. Open browser Developer Tools > Console
4. Verify:
   - ✅ Preview loads (not blank)
   - ✅ No "Minified React error #299"
   - ✅ No "Maximum update depth exceeded"
   - ✅ No "createRoot() called multiple times"

### WordPress Debug Log

Enable debug mode in `wp-config.php`:
```php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
```

Install the diagnostics plugin and check logs:
```bash
tail -f wp-content/debug.log | grep Customizer
```

Expected:
```
[Customizer Scripts] jquery, wp-api, wp-customize-preview, mytheme-customizer
[Customizer] Preview loaded successfully
```

Should NOT see:
```
[Warning] Potential duplicate packages: react, react-dom
```

---

## Common Issues and Solutions

### Issue: Blank/White Customizer Preview

**Symptoms:**
- Preview iframe shows blank white screen
- No error in browser console
- Other admin pages work fine

**Causes & Solutions:**

1. **Missing wp_footer()**
   - Check: `grep "wp_footer" footer.php`
   - Fix: Add `<?php wp_footer(); ?>` before `</body>`

2. **Missing wp_head()**
   - Check: `grep "wp_head" header.php`
   - Fix: Add `<?php wp_head(); ?>` before `</head>`

3. **Missing wp_body_open()**
   - Check: `grep "wp_body_open" header.php`
   - Fix: Add `<?php wp_body_open(); ?>` after `<body>`

### Issue: React Error #299 in Customizer

**Symptoms:**
- "Minified React error #299" in console
- "Maximum update depth exceeded"
- Preview partially works but crashes

**Cause:** Multiple `createRoot()` calls for same container

**Solution:** Implement single root instance pattern (see section 4 above)

### Issue: Customizer Preview Shows Security Warning

**Symptoms:**
- "Mixed content blocked" in console
- Some assets don't load in preview
- Works fine on regular front-end

**Cause:** HTTP URLs in HTTPS Customizer preview

**Solution:**
- Replace `http://` with `https://` for external URLs
- Use WordPress functions for theme assets:
  - `get_template_directory_uri()`
  - `get_stylesheet_uri()`
  - `wp_get_attachment_url()`

---

## Generator Validation Summary

| Component | Location | Status | Notes |
|-----------|----------|--------|-------|
| Header template | `wordpress_generator.py:1012-1041` | ✅ PASS | wp_head(), wp_body_open() present |
| Footer template | `wordpress_generator.py:1208-1264` | ✅ PASS | wp_footer(), visible content |
| Functions template | `code_validator.py:467-621` | ✅ PASS | No duplicate packages |
| HTTP URLs | All generator files | ✅ PASS | 0 HTTP URLs found |
| React mounting | N/A | ✅ N/A | Generator doesn't use React |

**Conclusion:** wpgen generator already follows all best practices. No changes needed to generator templates.

---

## Documentation Files

Two comprehensive reports have been generated:

1. **CUSTOMIZER_FIX_REPORT.md** (detailed validation report)
   - Complete validation results
   - Line-by-line verification
   - Testing checklist
   - Troubleshooting guide

2. **DIFFS_SUMMARY.md** (before/after comparisons)
   - Visual diffs for each fix
   - Code examples
   - Validation table
   - Quick reference

Both files are located in `/output/` directory.

---

## References

**WordPress Documentation:**
- [Theme Handbook](https://developer.wordpress.org/themes/)
- [Customizer API](https://developer.wordpress.org/themes/customize-api/)
- [wp_head() Hook](https://developer.wordpress.org/reference/hooks/wp_head/)
- [wp_footer() Hook](https://developer.wordpress.org/reference/hooks/wp_footer/)
- [wp_body_open() Hook](https://developer.wordpress.org/reference/hooks/wp_body_open/)

**Best Practices:**
- [WordPress Coding Standards](https://developer.wordpress.org/coding-standards/)
- [Theme Security](https://developer.wordpress.org/themes/theme-security/)
- [Block Editor Handbook](https://developer.wordpress.org/block-editor/)
- [JavaScript Best Practices](https://developer.wordpress.org/coding-standards/wordpress-coding-standards/javascript/)

**React in WordPress:**
- [Using React in WordPress](https://developer.wordpress.org/block-editor/reference-guides/packages/)
- [wp.element Package](https://developer.wordpress.org/block-editor/reference-guides/packages/packages-element/)
- [Block Editor Dependencies](https://developer.wordpress.org/block-editor/reference-guides/packages/)

---

**Document Version:** 1.0
**Last Updated:** 2025-11-23
**Status:** ✅ Generator validated and documented
