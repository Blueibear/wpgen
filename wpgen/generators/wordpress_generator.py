"""WordPress theme code generator.

This module generates complete WordPress themes based on parsed requirements.
It creates all necessary files including style.css, functions.php, templates, etc.
"""

import os
import re
import shutil
from datetime import datetime
from pathlib import Path
from typing import Any

from ..llm.base import BaseLLMProvider
from ..utils.code_validator import (
    clean_generated_code,
    generate_plugin_compatibility_layer,
    get_fallback_functions_php,
    get_fallback_template,
    remove_nonexistent_requires,
    repair_wordpress_code,
    repair_footer_php,
    validate_php_syntax,
)
from ..utils.logger import get_logger

logger = get_logger(__name__)


# Valid WordPress core block categories
VALID_BLOCK_CATEGORIES = {"text", "media", "design", "widgets", "theme", "embed"}

# Category normalization map for common invalid categories
BLOCK_CATEGORY_MAP = {
    "design_layout": "design",
    "layout": "design",
    "formatting": "text",
    "common": "text",
    "content": "text",
    "ecommerce": "widgets",
    "e-commerce": "widgets",
    "social": "widgets",
}


def normalize_block_category(category: str) -> str:
    """Normalize block category to a valid WordPress core category.

    Args:
        category: Block category name (may be invalid)

    Returns:
        Valid WordPress core block category
    """
    if not category or not isinstance(category, str):
        return "design"

    category_lower = category.lower().strip()

    # Check if it's already valid
    if category_lower in VALID_BLOCK_CATEGORIES:
        return category_lower

    # Check normalization map
    if category_lower in BLOCK_CATEGORY_MAP:
        return BLOCK_CATEGORY_MAP[category_lower]

    # Default to "design" for any unknown category
    logger.warning(f"Unknown block category '{category}', normalizing to 'design'")
    return "design"


def _ensure_style_header(theme_dir: str, requirements: dict, config: dict = None) -> None:
    """Ensure style.css has a valid WordPress theme header.

    Args:
        theme_dir: Path to theme directory
        requirements: Theme requirements dict
        config: WordPress configuration dict
    """
    config = config or {}
    style_path = os.path.join(theme_dir, "style.css")
    theme_name = (requirements.get("theme_display_name")
                  or requirements.get("theme_name") or "WPGen Theme")

    # Ensure theme_name is a string
    if not isinstance(theme_name, str):
        theme_name = str(theme_name) if theme_name else "WPGen Theme"

    slug = (requirements.get("slug") or theme_name).lower()

    # Ensure slug is a string (defensive check)
    if not isinstance(slug, str):
        slug = str(slug) if slug else "wpgen-theme"
        slug = slug.lower()

    text_domain = re.sub(r"[^a-z0-9-]+", "-", slug)

    # Get URIs from config or use defaults/derived values
    theme_uri = config.get("theme_uri", "")
    author = config.get("author", "WPGen")
    author_uri = config.get("author_uri", "")

    # If URIs not set, try to derive from GitHub repo if available
    if not theme_uri:
        theme_uri = requirements.get("repository_url", "https://wpgen.local/")

    if not author_uri:
        # Try to get owner URL from requirements if GitHub was used
        repo_url = requirements.get("repository_url", "")
        if repo_url and "github.com" in repo_url:
            # Extract owner from GitHub URL (e.g., https://github.com/owner/repo -> https://github.com/owner)
            parts = repo_url.rstrip("/").split("/")
            if len(parts) >= 4:
                author_uri = "/".join(parts[:4])
            else:
                author_uri = "https://wpgen.local/"
        else:
            author_uri = "https://wpgen.local/"

    header = f"""/*
Theme Name: {theme_name}
Theme URI: {theme_uri}
Author: {author}
Author URI: {author_uri}
Description: Theme generated by WPGen.
Version: 0.1.0
Text Domain: {text_domain}
*/"""

    if not os.path.exists(style_path):
        with open(style_path, "w", encoding="utf-8") as f:
            f.write(header + "\n\n/* Add theme styles below */\n")
        return

    original = open(style_path, "r", encoding="utf-8", errors="ignore").read()
    trimmed = original.lstrip()
    has_header = trimmed.startswith("/*") and "Theme Name:" in trimmed.split("*/", 1)[0]
    if not has_header:
        with open(style_path, "w", encoding="utf-8") as f:
            f.write(header + "\n\n" + original)


def _first_hex(color_scheme: str | None, fallback: str = "#0f172a") -> str:
    """Extract first hex color from color scheme string.

    Args:
        color_scheme: Color scheme string that may contain hex colors
        fallback: Default color if none found

    Returns:
        First hex color found or fallback
    """
    if not color_scheme:
        return fallback

    # Ensure color_scheme is a string (defensive check)
    if not isinstance(color_scheme, str):
        logger.warning(f"color_scheme is not a string: {type(color_scheme).__name__}, using fallback")
        return fallback

    m = re.search(r"#([0-9a-fA-F]{6})", color_scheme)
    return f"#{m.group(1)}" if m else fallback


def _ensure_screenshot(theme_dir: str, requirements: dict, images: list[dict[str, Any | None]]) -> None:
    """Ensure theme has a screenshot.png file.

    Creates a screenshot from the first user image or generates a placeholder.

    Args:
        theme_dir: Path to theme directory
        requirements: Theme requirements dict
        images: List of image dicts with 'path' key, or None
    """
    # Import PIL here to avoid hard dependency
    try:
        from PIL import Image, ImageDraw, ImageFont
    except ImportError:
        logger.warning("PIL (Pillow) not installed. Skipping screenshot generation.")
        return

    shot_path = os.path.join(theme_dir, "screenshot.png")
    if os.path.exists(shot_path):
        return

    # Try to use first uploaded image as screenshot
    if images and len(images) > 0:
        try:
            # Images are dicts with 'path', 'data', 'mime_type' etc
            img_data = images[0]
            if isinstance(img_data, dict):
                src = img_data.get('path')
                if not src:
                    logger.warning("Image dict has no 'path' key, falling back to placeholder")
                    raise ValueError("No path in image data")
            else:
                src = img_data

            # Verify path exists
            if not os.path.exists(src):
                logger.warning(f"Image path does not exist: {src}")
                raise FileNotFoundError(f"Image not found: {src}")

            with Image.open(src) as im:
                im = im.convert("RGB")
                canvas = Image.new("RGB", (1200, 900), (247, 248, 250))
                r = im.copy()
                r.thumbnail((1200, 900))
                x = (1200 - r.width) // 2
                y = (900 - r.height) // 2
                canvas.paste(r, (x, y))
                canvas.save(shot_path, format="PNG", optimize=True)
                logger.info(f"Generated screenshot from uploaded image: {os.path.basename(src)}")
                return
        except Exception as e:
            logger.warning(f"Could not use uploaded image for screenshot: {e}. Generating placeholder instead.")

    # Generate placeholder screenshot
    title = (requirements.get("theme_display_name")
             or requirements.get("theme_name") or "WPGen Theme")
    primary = _first_hex(requirements.get("color_scheme"), "#0f172a")
    bg = (248, 250, 252)
    fg = tuple(int(primary.strip("#")[i:i+2], 16) for i in (0, 2, 4))
    img = Image.new("RGB", (1200, 900), bg)
    draw = ImageDraw.Draw(img)
    draw.rectangle([0, 600, 1200, 900], fill=fg)
    try:
        font_title = ImageFont.truetype("DejaVuSans-Bold.ttf", 64)
        font_sub = ImageFont.truetype("DejaVuSans.ttf", 28)
    except Exception:
        font_title = ImageFont.load_default()
        font_sub = ImageFont.load_default()
    bbox = draw.textbbox((0, 0), title, font=font_title)
    tw = bbox[2] - bbox[0]
    draw.text(((1200 - tw)//2, 330), title, fill=(17, 24, 39), font=font_title)
    sub = "Generated by WPGen"
    bbox2 = draw.textbbox((0, 0), sub, font=font_sub)
    sw = bbox2[2] - bbox2[0]
    draw.text(((1200 - sw)//2, 410), sub, fill=(55, 65, 81), font=font_sub)
    img.save(shot_path, format="PNG", optimize=True)
    logger.info("Generated placeholder screenshot")


class WordPressGenerator:
    """Generator for WordPress theme code."""

    def __init__(
        self,
        llm_provider: BaseLLMProvider,
        output_dir: str = "output",
        config: dict[str, Any] = None,
    ):
        """Initialize the WordPress generator.

        Args:
            llm_provider: LLM provider for code generation
            output_dir: Base output directory for generated themes
            config: WordPress configuration from config.yaml
        """
        self.llm_provider = llm_provider
        self.output_dir = Path(output_dir)
        self.config = config or {}
        self.safe_mode = self.config.get("safe_mode", False)

        if self.safe_mode:
            logger.warning("‚ö†Ô∏è  SAFE MODE ENABLED - Using only validated fallback templates")

        logger.info(f"Initialized WordPressGenerator with output dir: {output_dir}")

    def generate(
        self, requirements: dict[str, Any], images: list[dict[str, Any | None]] = None
    ) -> str:
        """Generate a complete WordPress theme from requirements with optional visual references.

        Args:
            requirements: Parsed theme requirements
            images: Optional list of design mockup images for vision-based generation

        Returns:
            Path to the generated theme directory

        Raises:
            Exception: If generation fails
        """
        theme_name = requirements["theme_name"]
        logger.info(f"Starting theme generation: {theme_name}")

        # Store images for use in code generation methods
        self.design_images = images if images else None
        if self.design_images:
            logger.info(
                f"Using {len(self.design_images)} design reference image(s) for visual guidance"
            )

        # Create theme directory
        theme_dir = self.output_dir / theme_name
        if theme_dir.exists() and self.config.get("clean_before_generate", False):
            logger.warning(f"Cleaning existing theme directory: {theme_dir}")
            shutil.rmtree(theme_dir)

        theme_dir.mkdir(parents=True, exist_ok=True)
        logger.info(f"Created theme directory: {theme_dir}")

        try:
            # Generate core files
            self._generate_style_css(theme_dir, requirements)
            self._generate_functions_php(theme_dir, requirements)

            # Generate plugin compatibility directory structure
            self._generate_plugin_compatibility_structure(theme_dir)

            self._generate_index_php(theme_dir, requirements)
            self._generate_header_php(theme_dir, requirements)
            self._generate_footer_php(theme_dir, requirements)
            self._generate_sidebar_php(theme_dir, requirements)

            # Generate template files
            self._generate_templates(theme_dir, requirements)

            # Auto-generate missing template-parts files
            self._generate_template_parts(theme_dir, requirements)

            # Generate always-on UI enhancements (smooth transitions, mobile nav)
            self._generate_wpgen_ui_assets(theme_dir)

            # Generate base layout CSS for proper structural presentation
            self._generate_base_layout_css(theme_dir)

            # Generate optional features (if specified in requirements/context)
            self._generate_optional_features(theme_dir, requirements)

            # Generate additional files
            self._generate_readme(theme_dir, requirements)
            self._generate_gitignore(theme_dir)

            # Generate wp-config sample if requested
            if self.config.get("include_wp_config", True):
                self._generate_wp_config(theme_dir.parent, requirements)

            # Ensure theme identity (style header + screenshot)
            _ensure_style_header(str(theme_dir), requirements, self.config)
            _ensure_screenshot(str(theme_dir), requirements, images)
            logger.info("‚úì Theme thumbnail prepared (screenshot.png)")

            # Sanitize filenames to prevent duplicates and invalid extensions
            logger.info("Sanitizing theme filenames...")
            from ..utils.code_validator import validate_theme_filenames
            filename_results = validate_theme_filenames(theme_dir)

            if filename_results['renames']:
                logger.info(f"‚úì Sanitized {len(filename_results['renames'])} filename(s):")
                for rename in filename_results['renames']:
                    logger.info(f"  - {rename}")

            if filename_results['errors']:
                logger.warning(f"‚ö†Ô∏è Filename validation found {len(filename_results['errors'])} errors:")
                for error in filename_results['errors']:
                    logger.warning(f"  - {error}")

            # Validate and auto-fix template structure
            logger.info("Validating and fixing template structure...")
            from ..utils.code_validator import validate_and_fix_template_structure
            structure_validation = validate_and_fix_template_structure(theme_dir)

            if structure_validation['repairs']:
                logger.info(f"‚úì Auto-repaired {len(structure_validation['repairs'])} template issues:")
                for repair in structure_validation['repairs']:
                    logger.info(f"  - {repair}")

            if structure_validation['errors']:
                logger.warning(f"‚ö†Ô∏è Template structure validation found {len(structure_validation['errors'])} errors:")
                for error in structure_validation['errors'][:5]:
                    logger.warning(f"  - {error}")

            # Final WordPress safety validation
            logger.info("Performing final WordPress safety validation...")
            from ..utils.code_validator import validate_theme_for_wordpress_safety
            is_safe, issues = validate_theme_for_wordpress_safety(theme_dir)

            if not is_safe:
                logger.error("‚ö†Ô∏è  Theme validation found critical issues:")
                for issue in issues:
                    logger.error(f"  - {issue}")

                if not self.safe_mode:
                    logger.warning("Consider using safe_mode=True to use tested fallback templates")

                raise ValueError(
                    f"Generated theme has {len(issues)} critical issue(s) that would crash WordPress. "
                    f"Issues: {'; '.join(issues[:3])}. Enable safe_mode for reliable themes."
                )
            else:
                logger.info("‚úì Theme passed WordPress safety validation")

            # Scan for mixed-content (insecure http:// URLs)
            from ..utils.code_validator import scan_mixed_content
            scan_results = scan_mixed_content(theme_dir, enforce_https=True)

            if not scan_results['valid']:
                logger.warning("‚ö†Ô∏è  Mixed-content scan found insecure HTTP URLs:")
                for error in scan_results['errors']:
                    logger.warning(f"  {error}")
                logger.warning("These URLs may cause mixed-content warnings on HTTPS sites")
                # Note: We log as warning but don't fail generation since HTTP might be intentional
                # for local development. Production sites should use HTTPS.

            else:
                logger.info("‚úì No mixed-content (insecure HTTP URLs) detected")

            # Post-render scan: Check for forbidden patterns (WP_DEBUG, invalid PHP)
            logger.info("Running post-render scan for forbidden patterns...")
            from ..utils.code_validator import scan_generated_theme
            scan_results = scan_generated_theme(theme_dir, strict=True)

            if not scan_results['valid']:
                logger.error("‚úó Post-render scan FAILED - theme contains forbidden patterns:")
                for error in scan_results['all_errors']:
                    logger.error(f"  {error}")

                # Fail generation if forbidden patterns found
                raise ValueError(
                    f"Generated theme contains forbidden patterns. "
                    f"Found {len(scan_results['all_errors'])} issue(s). "
                    f"See errors above for details."
                )
            else:
                logger.info("‚úì Post-render scan passed - no forbidden patterns detected")

            logger.info(f"Successfully generated theme: {theme_name}")
            return str(theme_dir)

        except Exception as e:
            logger.error(f"Failed to generate theme: {str(e)}")
            raise

    # Inline guards for preventing forbidden patterns during file write
    FORBIDDEN_DEBUG_TOKENS = (
        "define('WP_DEBUG'", 'define("WP_DEBUG"',
        "define('WP_DEBUG_LOG'", 'define("WP_DEBUG_LOG"',
        "define('WP_DEBUG_DISPLAY'", 'define("WP_DEBUG_DISPLAY"',
        "ini_set('display_errors'", 'ini_set("display_errors"',
        "ini_set('error_reporting'", 'ini_set("error_reporting"',
        "error_reporting(",
    )

    BAD_PHP_PATTERNS = [
        (re.compile(r"<\?=\s*;?\s*\?>"), "<?= ; ?> or <?= ?> (empty short echo)"),
        (re.compile(r"<\?php\s*;+\s*\?>"), "<?php ; ?> (empty PHP block with semicolon)"),
        (re.compile(r"\bif\s*\([^)]*\)\s*;"), "if (...); (stray semicolon after condition)"),
        (re.compile(r"\bforeach\s*\([^)]*\)\s*;"), "foreach (...); (stray semicolon)"),
        (re.compile(r"\bwhile\s*\([^)]*\)\s*;"), "while (...); (stray semicolon)"),
        (re.compile(r"\bfor\s*\([^)]*\)\s*;"), "for (...); (stray semicolon)"),
        (re.compile(r"\bfunction\s+\w+\s*\([^)]*\)\s*;"), "function name(); (semicolon instead of brace)"),
    ]

    def _assert_no_debug_directives(self, text: str, path: str) -> None:
        """Assert that code contains no forbidden debug directives.

        Args:
            text: PHP code to check
            path: File path for error messages

        Raises:
            RuntimeError: If forbidden directive found
        """
        for i, line in enumerate(text.splitlines(), 1):
            for tok in self.FORBIDDEN_DEBUG_TOKENS:
                if tok in line:
                    raise RuntimeError(
                        f"Forbidden debug directive in {path}:{i}\n"
                        f"  Line: {line.strip()}\n"
                        f"  Pattern: {tok}\n"
                        f"Themes must NOT define WP_DEBUG, error_reporting, or ini_set.\n"
                        f"These belong in wp-config.php, not theme files."
                    )

    def _assert_no_bad_php(self, text: str, path: str) -> None:
        """Assert that code contains no invalid PHP patterns.

        Args:
            text: PHP code to check
            path: File path for error messages

        Raises:
            RuntimeError: If invalid pattern found
        """
        for rx, description in self.BAD_PHP_PATTERNS:
            m = rx.search(text)
            if m:
                # Find line number
                start = text.rfind("\n", 0, m.start()) + 1
                line_num = text[:m.start()].count("\n") + 1
                end = text.find("\n", m.end())
                snippet = text[start:(len(text) if end == -1 else end)]
                raise RuntimeError(
                    f"Invalid PHP pattern in {path}:{line_num}\n"
                    f"  Line: {snippet.strip()}\n"
                    f"  Pattern: {description}\n"
                    f"  Matched: '{m.group(0)}'"
                )

    def _generate_style_css(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate style.css file with theme header and styles.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating style.css")

        # Generate the header comment
        author = self.config.get("author", "WPGen")
        license = self.config.get("license", "GPL-2.0-or-later")
        version = "1.0.0"
        wp_version = self.config.get("wp_version", "6.4")

        # Get URIs from config or derive from GitHub repo
        theme_uri = self.config.get("theme_uri", "")
        author_uri = self.config.get("author_uri", "")

        if not theme_uri:
            theme_uri = requirements.get("repository_url", f"https://github.com/yourusername/{requirements['theme_name']}")

        if not author_uri:
            # Try to get owner URL from requirements if GitHub was used
            repo_url = requirements.get("repository_url", "")
            if repo_url and "github.com" in repo_url:
                # Extract owner from GitHub URL
                parts = repo_url.rstrip("/").split("/")
                if len(parts) >= 4:
                    author_uri = "/".join(parts[:4])
                else:
                    author_uri = "https://github.com/yourusername"
            else:
                author_uri = "https://github.com/yourusername"

        # Ensure tags are properly formatted as comma-separated strings
        features = requirements.get('features', [])
        if isinstance(features, list):
            # Convert list to comma-separated string, limit to 5 tags
            # Clean each tag to be WordPress-compatible (lowercase, no special chars)
            clean_tags = []
            for feature in features[:5]:
                if isinstance(feature, str):
                    # Convert to lowercase, replace spaces/underscores with hyphens
                    clean_tag = re.sub(r'[^a-z0-9-]+', '-', feature.lower()).strip('-')
                    if clean_tag:
                        clean_tags.append(clean_tag)
            tags_str = ', '.join(clean_tags)
        else:
            tags_str = str(features) if features else 'wordpress, theme'

        header = f"""/*
Theme Name: {requirements['theme_display_name']}
Theme URI: {theme_uri}
Author: {author}
Author URI: {author_uri}
Description: {requirements['description']}
Version: {version}
Requires at least: {wp_version}
Tested up to: {wp_version}
Requires PHP: 7.4
License: {license}
License URI: https://www.gnu.org/licenses/gpl-2.0.html
Text Domain: {requirements['theme_name']}
Tags: {tags_str}
*/

"""

        # Generate CSS using LLM
        context = {
            "theme_name": requirements["theme_name"],
            "color_scheme": requirements.get("color_scheme", "default"),
            "layout": requirements.get("layout", "full-width"),
            "features": requirements.get("features", []),
        }

        # Add design profile context if available
        design_profile = requirements.get("design_profile")
        if design_profile:
            context["design_profile"] = design_profile

        description = f"""IMPORTANT: Respond ONLY with valid CSS code. No explanations, no markdown, no comments outside the CSS.

Create a modern, visually attractive, production-ready CSS stylesheet for a WordPress theme.
This should be a COMPLETE, FULLY-STYLED theme - not a minimal boilerplate.

"""

        # Add design profile details if available
        if design_profile:
            from ..design_profiles import profile_to_prompt_context, DesignProfile
            from ..design_inspiration import get_inspiration_context

            # Convert dict back to DesignProfile if needed
            if isinstance(design_profile, dict):
                temp_profile = DesignProfile(design_profile['name'], design_profile['description'])
                temp_profile.colors = design_profile['colors']
                temp_profile.fonts = design_profile['fonts']
                temp_profile.spacing = design_profile['spacing']
                temp_profile.layout = design_profile['layout']
                temp_profile.components = design_profile['components']
                description += "DESIGN SYSTEM:\n"
                description += profile_to_prompt_context(temp_profile)
                description += "\n\n"

                # Add design inspiration context
                inspiration_context = get_inspiration_context(design_profile['name'])
                if inspiration_context:
                    description += inspiration_context
                    description += "\n\n"

            description += "Use these exact colors, fonts, spacing, and component styles in the CSS.\n"
        else:
            description += f"""DESIGN SYSTEM:
Color Scheme: {context['color_scheme']}
Layout Type: {context['layout']}
Use a cohesive, professional color palette with primary, secondary, and accent colors.
"""

        description += """
REQUIRED CSS STRUCTURE:

1. CSS CUSTOM PROPERTIES (CSS Variables)
   - Define all colors as CSS variables
   - Define spacing scale (4px, 8px, 16px, 24px, 32px, 48px, 64px, 96px, 128px)
   - Define typography scale using modular scale
   - Define layout breakpoints
   - Define transition/animation values

2. MODERN CSS RESET
   - Box-sizing: border-box
   - Remove default margins/padding
   - Set modern font stack
   - Smooth scrolling
   - Better image defaults

3. TYPOGRAPHY SYSTEM
   - Strong hierarchy: h1 (3rem+), h2 (2.5rem), h3 (2rem), h4 (1.5rem), h5 (1.25rem), h6 (1rem)
   - Proper line heights (headings: 1.2, body: 1.6)
   - Font weights (headings: 700, body: 400)
   - Letter spacing for headings
   - Responsive font sizes using clamp()

4. LAYOUT & GRID SYSTEM
   - Semantic HTML5 structure (.site-header, .site-main, .site-footer)
   - Container with max-width and centered
   - Flexible grid system (.grid, .grid-2, .grid-3, .grid-4)
   - Flexbox utilities (.flex, .flex-center, .flex-between)
   - Proper spacing between sections

5. HERO SECTION STYLES
   - Full-width hero banner (.hero-section)
   - Background image support with overlay
   - Centered content with strong typography
   - Call-to-action button styling
   - Minimum height: 500px
   - Responsive padding

6. MODERN HEADER
   - Fixed or sticky header option
   - Flexbox layout for logo and navigation
   - Mobile hamburger menu styles
   - Smooth transitions
   - Shadow on scroll effect
   - Logo sizing and spacing

7. NAVIGATION
   - Horizontal desktop navigation
   - Proper spacing and hover states
   - Active page indicator
   - Mobile menu (off-canvas or dropdown)
   - Smooth transitions and animations
   - Touch-friendly tap targets (44px minimum)

8. BUTTON STYLES
   - Primary button (.btn, .btn-primary)
   - Secondary button (.btn-secondary)
   - Outline button (.btn-outline)
   - Large size (.btn-lg)
   - Consistent padding (1em 2em)
   - Hover effects (transform, color change, shadow)
   - Focus states for accessibility

9. CARD COMPONENTS
   - Product cards (.product-card)
   - Blog post cards (.post-card)
   - Promo cards (.promo-card)
   - Card shadows and borders
   - Image aspect ratios
   - Hover lift effects
   - Proper spacing inside cards

10. CONTENT SECTIONS
    - Section spacing (.section)
    - Content width constraints
    - Background variations (.bg-light, .bg-dark)
    - Padding responsive to screen size

11. WOOCOMMERCE PRODUCT GRIDS
    - Product grid layout (.products.columns-3)
    - Product card styles
    - Product image sizing
    - Price typography
    - Add to cart button styles
    - Sale badges
    - Product hover effects

12. FOOTER
    - Multi-column footer layout
    - Widget area styling
    - Footer menus
    - Social icons
    - Copyright section
    - Proper spacing and typography

13. ANIMATIONS & TRANSITIONS
    - Smooth transitions on interactive elements (0.3s ease)
    - Hover effects (transform: translateY, scale)
    - Fade-in animations for content
    - Loading states
    - Focus indicators

14. RESPONSIVE DESIGN
    - Mobile-first approach
    - Breakpoints: 640px (sm), 768px (md), 1024px (lg), 1280px (xl)
    - Stack grid columns on mobile
    - Adjust typography scale
    - Mobile navigation
    - Touch-friendly spacing

15. WORDPRESS CORE CLASSES
    - Alignment classes (.alignleft, .alignright, .aligncenter, .alignwide, .alignfull)
    - Image captions (.wp-caption)
    - Galleries (.gallery)
    - Sticky posts
    - Comment styles
    - Gutenberg block styles

16. UTILITY CLASSES
    - Spacing utilities (.mt-*, .mb-*, .py-*, .px-*)
    - Text utilities (.text-center, .text-uppercase, .font-bold)
    - Display utilities (.hidden, .block, .flex)
    - Color utilities (.text-primary, .bg-primary)

CRITICAL REQUIREMENTS:
- Use real, specific color values (not placeholders)
- Include complete styling - this should look professional immediately
- Add smooth transitions and hover effects everywhere
- Use modern CSS features (Grid, Flexbox, CSS Variables, clamp())
- Make it mobile-first and fully responsive
- Include visual hierarchy and whitespace
- Add shadows, borders, and visual depth
- Style all WordPress elements (posts, comments, widgets)
- Include sample content styling (blockquotes, lists, code, tables)

DO NOT create minimal or placeholder styles. Every element should be fully styled and production-ready.
The theme should look modern, professional, and visually impressive when activated."""

        try:
            # Pass design images for visual reference (especially important for CSS styling)
            css_code = self.llm_provider.generate_code(
                description, "css", context, images=self.design_images
            )
            # CRITICAL: Clean LLM output to remove markdown fences and explanatory text
            css_code = clean_generated_code(css_code, 'css')
            full_css = header + css_code

            style_file = theme_dir / "style.css"
            style_file.write_text(full_css, encoding="utf-8")
            logger.info("Generated style.css successfully")

        except Exception as e:
            logger.error(f"Failed to generate style.css: {str(e)}")
            # Write minimal fallback
            style_file = theme_dir / "style.css"
            style_file.write_text(header + "\n/* Add your styles here */\n", encoding="utf-8")

    def _generate_functions_php(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate functions.php file.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating functions.php")

        # SAFE MODE: Always use fallback
        if self.safe_mode:
            logger.info("Safe mode: Using fallback functions.php")
            php_code = get_fallback_functions_php(requirements["theme_name"])
            functions_file = theme_dir / "functions.php"
            functions_file.write_text(php_code, encoding="utf-8")
            logger.info("Created safe-mode functions.php")
            return

        context = {
            "theme_name": requirements["theme_name"],
            "features": requirements.get("features", []),
            "navigation": requirements.get("navigation", []),
            "post_types": requirements.get("post_types", []),
            "integrations": requirements.get("integrations", []),
        }

        description = f"""IMPORTANT: Respond ONLY with valid PHP code for functions.php. No explanations, no markdown code fences, no comments before the code. Start directly with <?php.

Create a complete, modern functions.php file for a WordPress theme named '{requirements["theme_name"]}'.

CRITICAL REQUIREMENTS:
1. Use proper PHP function naming - replace hyphens with underscores in function names
2. Include these EXACT helper functions (replace THEMESLUG with safe function name):
   - THEMESLUG_get_the_meta_data() - displays post date and author
   - THEMESLUG_get_the_image($size='large') - displays post thumbnail with fallback
   - THEMESLUG_pagination() - pagination with wp_pagenavi fallback
   - THEMESLUG_posts_pagination() - posts pagination with fallback

Include:
- Theme setup function with theme support declarations (title-tag, post-thumbnails, html5, custom-logo, responsive-embeds, etc.)
- Custom logo support with max height of 80px
- Enqueue scripts and styles (MUST enqueue base layout CSS and wpgen-ui assets)
- Register navigation menus: primary and footer locations
- Register widget areas (sidebar-1, footer-1, footer-2, footer-3 minimum)
- Custom post types: {', '.join(context['post_types'])}
- Theme customizer settings
- Security best practices (sanitization, escaping)

SHORTCODES - Include these modern shortcodes:
1. Product Grid Shortcode [product_grid]:
   - Displays a grid of recent posts or products
   - Attributes: count (default 6), columns (default 3), category
   - Uses the .grid and .post-card classes
   - Includes post thumbnail, title, excerpt, and read more link

2. Hero Banner Shortcode [hero_banner]:
   - Displays a hero section with title, text, and buttons
   - Attributes: title, text, button_text, button_url
   - Uses .hero-section class

3. Call-to-Action Shortcode [cta_box]:
   - Displays a CTA section
   - Attributes: title, text, button_text, button_url, background (primary/secondary)
   - Uses .cta-section class

HELPER FUNCTIONS - Include these exactly:
- {requirements["theme_name"].replace('-', '_')}_get_the_meta_data() - echo date and author with escaping
- {requirements["theme_name"].replace('-', '_')}_get_the_image($size='large') - the_post_thumbnail() with fallback
- {requirements["theme_name"].replace('-', '_')}_pagination() - uses wp_pagenavi() if exists, else the_posts_navigation()
- {requirements["theme_name"].replace('-', '_')}_posts_pagination() - uses wp_pagenavi() if exists, else the_posts_pagination()

IMPORTANT: Always enqueue these assets in the correct order:
1. Base layout stylesheet (required for proper structure):
   wp_enqueue_style('theme-base-layout', get_template_directory_uri() . '/assets/css/style.css', array(), '1.0.0');
2. Main theme stylesheet:
   wp_enqueue_style('theme-style', get_stylesheet_uri(), array('theme-base-layout'), wp_get_theme()->get('Version'));
3. WPGen UI enhancements:
   wp_enqueue_style('wpgen-ui', get_template_directory_uri() . '/assets/css/wpgen-ui.css', array(), '1.0.0');
   wp_enqueue_script('wpgen-ui', get_template_directory_uri() . '/assets/js/wpgen-ui.js', array(), '1.0.0', true);

Note: theme-base-layout provides structural CSS and must load first.

CRITICAL: Front-end vs Editor Asset Separation - STRICTLY ENFORCE
- wp_enqueue_scripts hook: ONLY front-end assets (NO React, NO @wordpress/*, NO Jetpack, NO wp-element, NO wp-blocks, NO wp-data)
- enqueue_block_editor_assets hook: ONLY editor assets (React, Gutenberg, @wordpress/* packages, Jetpack blocks)
- customize_preview_init hook: NO editor/Gutenberg/Jetpack packages (use vanilla JS only)
- NEVER load these on front-end: react, react-dom, @wordpress/blocks, @wordpress/element, @wordpress/data, wp-blocks, wp-element, jetpack-*
- Violating this will cause white Customizer screen, React errors, and Jetpack store conflicts.
- If you need interactivity on front-end, use vanilla JavaScript or jQuery (already available in WordPress)."""

        try:
            # Pass design images for visual reference
            php_code = self.llm_provider.generate_code(
                description, "php", context, images=self.design_images
            )

            # CRITICAL: Clean LLM output FIRST before any special handling
            # This removes markdown fences and explanatory text
            php_code = clean_generated_code(php_code, 'php')

            # Ensure PHP opening tag
            if not php_code.strip().startswith("<?php"):
                php_code = "<?php\n" + php_code

            # Generate and prepend plugin compatibility layer
            compatibility_layer, injected_items = generate_plugin_compatibility_layer(
                requirements["theme_name"]
            )

            # Remove the <?php tag from compatibility layer since we'll merge it with the generated code
            compatibility_layer_without_php_tag = compatibility_layer.replace("<?php\n", "").strip()

            # Insert compatibility layer right after the opening <?php tag
            if php_code.strip().startswith("<?php"):
                # Split at first line break after <?php
                parts = php_code.split("\n", 1)
                if len(parts) > 1:
                    php_code = parts[0] + "\n" + compatibility_layer_without_php_tag + "\n\n" + parts[1]
                else:
                    php_code = parts[0] + "\n" + compatibility_layer_without_php_tag + "\n"
            else:
                # Fallback: just prepend it
                php_code = "<?php\n" + compatibility_layer_without_php_tag + "\n\n" + php_code

            logger.info(f"Injected plugin compatibility layer: {', '.join(injected_items)}")

            # Remove require/include statements for non-existent files
            php_code = remove_nonexistent_requires(php_code, theme_dir)

            # Use comprehensive validation with fallback
            fallback_code = get_fallback_functions_php(requirements["theme_name"])
            self._validate_and_write_php(theme_dir, "functions.php", php_code, fallback_code)

        except Exception as e:
            logger.error(f"Failed to generate functions.php: {str(e)}")
            logger.warning("Using fallback functions.php template")
            php_code = get_fallback_functions_php(requirements["theme_name"])
            functions_file = theme_dir / "functions.php"
            functions_file.write_text(php_code, encoding="utf-8")
            logger.info("Created fallback functions.php")

    def _generate_plugin_compatibility_structure(self, theme_dir: Path) -> None:
        """Generate plugin compatibility directory structure with placeholder files.

        Creates the directory structure needed for plugin compatibility to prevent
        fatal PHP errors when plugins expect certain files to exist.

        Args:
            theme_dir: Theme directory path
        """
        logger.info("Generating plugin compatibility directory structure")

        # Create the directory structure: includes/customizer/controls/selectbtn/
        compat_dir = theme_dir / "includes" / "customizer" / "controls" / "selectbtn"
        compat_dir.mkdir(parents=True, exist_ok=True)

        # Create the placeholder file
        placeholder_file = compat_dir / "class-responsive-customizer-responsive-selectbtn-control.php"
        placeholder_content = """<?php
// Placeholder file added by generator to prevent plugin compatibility errors.
?>"""

        placeholder_file.write_text(placeholder_content, encoding="utf-8")
        logger.info("Created plugin compatibility structure: includes/customizer/controls/selectbtn/")

    def _validate_and_write_php(
        self, theme_dir: Path, filename: str, php_code: str, fallback_code: str | None = None
    ) -> None:
        """Validate PHP code and write to file with comprehensive validation and fallback.

        Args:
            theme_dir: Theme directory path
            filename: Name of the PHP file
            php_code: Generated PHP code
            fallback_code: Optional fallback code if validation fails
        """
        from ..utils.code_validator import validate_and_repair_php_file

        # CRITICAL: Clean LLM output FIRST to remove markdown fences, explanatory text,
        # and invisible Unicode characters. This must happen BEFORE any other processing.
        php_code = clean_generated_code(php_code, 'php')
        logger.debug(f"Cleaned LLM output for {filename}")

        # Ensure PHP opening tag
        if not php_code.strip().startswith("<?php") and not php_code.strip().startswith("<!DOCTYPE"):
            php_code = "<?php\n" + php_code

        # Get theme name from theme_dir
        theme_name = theme_dir.name

        # Determine file type for structure validation
        file_type = 'template'
        if filename == 'header.php':
            file_type = 'header'
        elif filename == 'footer.php':
            file_type = 'footer'
        elif filename == 'functions.php':
            file_type = 'functions'

        # Use comprehensive validation and repair (with up to 2 retry attempts)
        # For footer.php, pass theme_dir to enable PHP syntax validation
        final_code, is_valid, log_messages = validate_and_repair_php_file(
            php_code,
            file_type=file_type,
            filename=filename,
            max_retries=2,
            theme_dir=theme_dir
        )

        # Log all validation messages
        for msg in log_messages:
            if '‚úì' in msg:
                logger.info(msg)
            elif '‚úó' in msg:
                logger.error(msg)
            else:
                logger.warning(msg)

        # If validation still failed after retries, use fallback
        if not is_valid:
            if fallback_code:
                logger.warning(f"‚Üí USING FALLBACK: {filename}")
                final_code = fallback_code

                # Validate the fallback too
                fallback_valid, fallback_msg = validate_php_syntax(fallback_code)
                if not fallback_valid:
                    logger.error(f"‚ö† FALLBACK {filename} ALSO HAS ERRORS: {fallback_msg}")
                else:
                    logger.info(f"‚úì Fallback {filename} validated successfully")
            else:
                logger.error(f"‚ö† No fallback available for {filename}, using best-effort repaired code")

        # Inline guard: Check for forbidden debug directives (except in wp-config files)
        if filename not in ['wp-config-sample.php', 'wp-config.php']:
            self._assert_no_debug_directives(final_code, filename)

        # Inline guard: Check for invalid PHP patterns
        self._assert_no_bad_php(final_code, filename)

        # Write the file (INITIAL WRITE)
        file_path = theme_dir / filename
        file_path.write_text(final_code, encoding="utf-8")
        logger.info(f"‚Üí Written {filename} (initial)")

        # ==============================================
        # FINAL PASS: Post-write sanitization and validation
        # This runs AFTER the file is written to disk
        # ==============================================
        from ..utils.code_validator import (
            final_pass_sanitizer,
            validate_footer_php_syntax,
            get_minimal_fallback
        )

        # Step 1: Read the written file back from disk
        written_content = file_path.read_text(encoding="utf-8")

        # Step 2: Run final-pass sanitizer (aggressive backslash removal)
        logger.info(f"üîß FINAL PASS: Running aggressive sanitizer on {filename}")
        sanitized_content, sanitizer_cleanups = final_pass_sanitizer(written_content, filename)

        if sanitizer_cleanups:
            logger.warning(f"üßπ FINAL PASS: Sanitized {filename}:")
            for cleanup in sanitizer_cleanups:
                logger.warning(f"  {cleanup}")

        # Step 3: Validate with php -l AFTER sanitizing
        logger.info(f"üîç FINAL PASS: Validating {filename} with php -l")
        syntax_valid, syntax_error, syntax_issues = validate_footer_php_syntax(
            sanitized_content, theme_dir
        )

        # Step 4: If validation fails, use minimal fallback (NOT LLM regeneration)
        if not syntax_valid and syntax_error:
            logger.error(f"‚úó FINAL PASS: {filename} still has PHP syntax errors after sanitization")
            logger.error(f"  Error: {syntax_error}")
            logger.warning(f"‚Üí USING MINIMAL FALLBACK: {filename}")

            # Use minimal non-breaking fallback
            minimal_fallback = get_minimal_fallback(filename, theme_name)
            sanitized_content = minimal_fallback

            # Log the fallback usage
            logger.warning(f"‚ö† Replaced {filename} with guaranteed-safe minimal fallback")
        elif syntax_issues and not syntax_error:
            # PHP CLI not available, skip syntax check
            logger.info(f"‚ö† PHP CLI not available, skipping syntax validation for {filename}")
        else:
            logger.info(f"‚úì FINAL PASS: {filename} passed PHP syntax validation")

        # Step 5: Rewrite the file with sanitized/fallback content
        if sanitized_content != written_content:
            file_path.write_text(sanitized_content, encoding="utf-8")
            logger.info(f"‚úì FINAL PASS: Rewrote {filename} with sanitized content")
        else:
            logger.info(f"‚úì FINAL PASS: {filename} required no changes")

        logger.info(f"‚úì {filename} finalized and ready")

    def _generate_index_php(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate index.php template file.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating index.php")

        context = {
            "theme_name": requirements["theme_name"],
            "layout": requirements.get("layout", "full-width"),
        }

        description = """Create the main index.php template file for WordPress.
This is the fallback template that MUST display content in ALL cases (Customizer preview, empty site, etc.).

CRITICAL REQUIREMENTS - NON-NEGOTIABLE:
1. MUST start with <?php get_header(); ?>
2. MUST end with <?php get_footer(); ?>
3. MUST use the standard WordPress loop - EXACTLY like this:
   <?php if ( have_posts() ) : ?>
       <?php while ( have_posts() ) : the_post(); ?>
           <article id="post-<?php the_ID(); ?>" <?php post_class(); ?>>
               <?php the_content(); ?>
           </article>
       <?php endwhile; ?>
   <?php else : ?>
       <article class="no-content">
           <h1><?php esc_html_e('Nothing to display yet', 'theme'); ?></h1>
           <p><?php esc_html_e('Add a page or post to see live preview here.', 'theme'); ?></p>
       </article>
   <?php endif; ?>
4. NEVER use undefined functions like post_loop()
5. Use standard WordPress functions: the_title(), the_content(), the_excerpt(), the_permalink(), etc.
6. ALWAYS include an 'else' clause with visible fallback content for empty sites (Customizer will be blank without this!)

Include:
- <main id="site-content" class="site-content"> wrapper
- get_header() call at the top
- The WordPress loop with have_posts() and the_post()
- Visible fallback content in the else clause (NO blank screen in Customizer!)
- Post title, content, meta (using standard WP functions)
- Pagination using the_posts_pagination() or the_posts_navigation()
- get_footer() call at the bottom

Use modern WordPress template tags and best practices."""

        try:
            # Pass design images for layout/structure reference
            php_code = self.llm_provider.generate_code(
                description, "php", context, images=self.design_images
            )

            self._validate_and_write_php(theme_dir, "index.php", php_code)

        except Exception as e:
            logger.error(f"Failed to generate index.php: {str(e)}")
            # Use rich fallback
            from ..fallback_templates import get_rich_fallback_index
            fallback = get_rich_fallback_index(requirements["theme_name"])
            logger.info("Using rich fallback template for index.php")
            self._validate_and_write_php(theme_dir, "index.php", fallback)

    def _generate_header_php(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate header.php template file.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating header.php")

        # Import header pattern for structured guidance
        from ..patterns import pattern_to_prompt_context

        header_pattern = pattern_to_prompt_context('header')

        context = {
            "theme_name": requirements["theme_name"],
            "navigation": requirements.get("navigation", []),
        }

        description = f"""IMPORTANT: Respond ONLY with valid PHP/HTML code for header.php. No explanations, no markdown code fences, no comments before the code.

Create a modern, fully-featured header.php template for WordPress theme.

HEADER DESIGN PATTERN:

{header_pattern}

CRITICAL REQUIREMENTS - Modern Header Structure:

1. DOCUMENT HEAD:
   - Full DOCTYPE html with language attributes
   - Meta charset and viewport
   - wp_head() hook before </head>
   - Proper HTML5 document structure

2. SEMANTIC HEADER STRUCTURE:
   - Use <header class="site-header"> as main container
   - Add <div class="header-inner container"> for width constraint
   - Wrap logo and title in <div class="site-branding">
   - Include the_custom_logo() for logo display
   - Use conditional h1/p for site title (h1 on front page, p on others)
   - Wrap navigation in <nav class="main-navigation">
   - Use flexbox layout classes (.flex, .flex-between, .flex-center)

3. MOBILE NAVIGATION:
   - Add mobile menu toggle button with hamburger icon (‚ò∞)
   - Button should have class "mobile-menu-toggle" and aria-label
   - Add data attribute or JS hook for mobile menu
   - Include proper accessibility attributes (aria-expanded, aria-controls)

4. NAVIGATION STRUCTURE:
   - Desktop navigation with wp_nav_menu()
   - Menu should have class "primary-menu"
   - Include proper container and menu classes
   - Add support for dropdown/submenu styling

5. SAMPLE STRUCTURE:
<!DOCTYPE html>
<html <?php language_attributes(); ?>>
<head>
    <meta charset="<?php bloginfo( 'charset' ); ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="profile" href="https://gmpg.org/xfn/11">
    <?php wp_head(); ?>
</head>
<body <?php body_class(); ?>>
<?php wp_body_open(); ?>
<header class="site-header">
    <div class="header-inner container">
        <div class="site-branding">
            <?php the_custom_logo(); ?>
            <div class="site-title-group">
                <?php if ( is_front_page() && is_home() ) : ?>
                    <h1 class="site-title"><a href="<?php echo esc_url( home_url( '/' ) ); ?>"><?php bloginfo( 'name' ); ?></a></h1>
                <?php else : ?>
                    <p class="site-title"><a href="<?php echo esc_url( home_url( '/' ) ); ?>"><?php bloginfo( 'name' ); ?></a></p>
                <?php endif; ?>
                <p class="site-description"><?php bloginfo( 'description' ); ?></p>
            </div>
        </div>

        <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
            <span class="menu-icon"></span>
        </button>

        <nav class="main-navigation" aria-label="Primary Navigation">
            <?php
            wp_nav_menu( array(
                'theme_location' => 'primary',
                'menu_class'     => 'primary-menu',
                'container'      => false,
            ) );
            ?>
        </nav>
    </div>
</header>
<main id="main" class="site-main">

6. STYLING CONSIDERATIONS:
   - Header should support sticky/fixed positioning via CSS
   - Logo should be properly sized
   - Mobile menu toggle should only show on mobile
   - Desktop navigation should be horizontal
   - Include proper spacing and alignment
   - Support for search icon or CTA button (optional)

7. WORDPRESS STANDARDS:
   - Use proper escaping (esc_url, esc_html, etc.)
   - Follow WordPress coding standards
   - Include proper indentation
   - Add inline comments for complex sections

IMPORTANT: Create a complete, production-ready header with modern navigation, mobile menu support, and clean semantic HTML."""

        try:
            # Pass design images for header layout/navigation reference
            php_code = self.llm_provider.generate_code(
                description, "php", context, images=self.design_images
            )

            # CRITICAL: Clean LLM output FIRST before any special handling
            # This removes markdown fences and explanatory text before we check for DOCTYPE
            php_code = clean_generated_code(php_code, 'php')

            # Special handling for header - might start with <!DOCTYPE
            # Now that output is cleaned, this check works correctly
            if not php_code.strip().startswith("<!DOCTYPE") and not php_code.strip().startswith(
                "<?php"
            ):
                php_code = "<?php\n" + php_code

            # Validate that generated code has required semantic structure
            has_site_header = 'site-header' in php_code
            has_site_branding = 'site-branding' in php_code
            has_custom_logo = 'the_custom_logo()' in php_code
            has_main_nav = 'main-navigation' in php_code

            if not (has_site_header and has_site_branding and has_custom_logo and has_main_nav):
                logger.warning("Generated header.php missing required semantic structure - using fallback")
                logger.warning(f"  site-header: {has_site_header}, site-branding: {has_site_branding}, "
                             f"the_custom_logo(): {has_custom_logo}, main-navigation: {has_main_nav}")
                # Use fallback template
                raise ValueError("Generated header missing required structure")

            self._validate_and_write_php(theme_dir, "header.php", php_code)

        except Exception as e:
            logger.error(f"Failed to generate header.php: {str(e)}")
            fallback = """<!DOCTYPE html>
<html <?php language_attributes(); ?>>
<head>
    <meta charset="<?php bloginfo( 'charset' ); ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <?php wp_head(); ?>
</head>
<body <?php body_class(); ?>>
<?php wp_body_open(); ?>
<header class="site-header">
    <div class="site-branding">
        <?php the_custom_logo(); ?>
        <?php if ( is_front_page() && is_home() ) : ?>
            <h1 class="site-title"><a href="<?php echo esc_url( home_url( '/' ) ); ?>"><?php bloginfo( 'name' ); ?></a></h1>
        <?php else : ?>
            <p class="site-title"><a href="<?php echo esc_url( home_url( '/' ) ); ?>"><?php bloginfo( 'name' ); ?></a></p>
        <?php endif; ?>
    </div>
    <nav class="main-navigation">
        <?php
        wp_nav_menu( array(
            'theme_location' => 'primary',
            'menu_class'     => 'primary-menu',
        ) );
        ?>
    </nav>
</header>
<main id="main" class="site-main">
"""
            self._validate_and_write_php(theme_dir, "header.php", fallback)

    def _generate_footer_php(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate footer.php template file.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating footer.php")

        # Import footer pattern for structured guidance
        from ..patterns import pattern_to_prompt_context

        footer_pattern = pattern_to_prompt_context('footer')

        context = {"theme_name": requirements["theme_name"]}

        description = f"""IMPORTANT: Respond ONLY with valid PHP/HTML code for footer.php. No explanations, no markdown code fences, no comments before the code.

Create a modern, fully-featured footer.php template for WordPress theme.

FOOTER DESIGN PATTERN:

{footer_pattern}

CRITICAL REQUIREMENTS - Footer Must Prevent Blank Screens:

1. CLOSE MAIN CONTENT AREA:
   - Include closing </main> tag if header.php opens it
   - Example: </main><!-- .site-main -->
   - If unsure, include it - won't cause issues if redundant

2. SEMANTIC FOOTER TAG WITH VISIBLE CONTENT:
   - MUST use semantic <footer> tag with any class name
   - Footer MUST contain visible content to prevent layout collapse
   - Include container div inside footer for structure
   - Example: <footer class="site-footer"> or <footer class="footer">

3. FOOTER WIDGET AREAS WITH ALWAYS-VISIBLE FALLBACK:
   - Create multi-column footer widget layout (2-4 columns)
   - Each widget area has unique ID (footer-1, footer-2, footer-3)
   - CRITICAL: MUST include visible fallback content when widgets are not active
   - Use if/else with dynamic_sidebar() to show fallback when no widgets
   - Fallback content: "About", "Quick Links", "Connect" with real text
   - This ensures footer NEVER appears empty
   - Wrap in container div for width constraint

4. FOOTER CREDITS SECTION:
   - Include <div class="site-info"> section with copyright
   - Include current year: date('Y')
   - Include site name: bloginfo('name')
   - Example: "&copy; 2024 Site Name. All rights reserved."
   - This adds visible content to prevent blank footers

5. WORDPRESS HOOKS (CRITICAL):
   - MUST include <?php wp_footer(); ?> before </body>
   - MUST include closing </body> and </html> tags
   - These are required for WordPress to function properly
   - Missing these causes WordPress Customizer to fail

6. SAMPLE STRUCTURE WITH VISIBLE FALLBACK CONTENT:
</main><!-- .site-main -->

<footer class="site-footer">
    <div class="footer-widgets container">
        <div class="footer-widgets-inner grid grid-3">
            <?php if ( is_active_sidebar( 'footer-1' ) ) : ?>
                <div class="footer-widget-area footer-widget-1">
                    <?php dynamic_sidebar( 'footer-1' ); ?>
                </div>
            <?php else : ?>
                <div class="footer-widget-area footer-widget-1">
                    <h3 class="widget-title">About</h3>
                    <p>Welcome to our website. Visit us to learn more.</p>
                </div>
            <?php endif; ?>

            <?php if ( is_active_sidebar( 'footer-2' ) ) : ?>
                <div class="footer-widget-area footer-widget-2">
                    <?php dynamic_sidebar( 'footer-2' ); ?>
                </div>
            <?php else : ?>
                <div class="footer-widget-area footer-widget-2">
                    <h3 class="widget-title">Quick Links</h3>
                    <ul>
                        <li><a href="<?php echo esc_url( home_url( '/' ) ); ?>">Home</a></li>
                    </ul>
                </div>
            <?php endif; ?>

            <?php if ( is_active_sidebar( 'footer-3' ) ) : ?>
                <div class="footer-widget-area footer-widget-3">
                    <?php dynamic_sidebar( 'footer-3' ); ?>
                </div>
            <?php else : ?>
                <div class="footer-widget-area footer-widget-3">
                    <h3 class="widget-title">Connect</h3>
                    <p>Stay connected with us.</p>
                </div>
            <?php endif; ?>
        </div>
    </div>

    <div class="site-info">
        <div class="container">
            <p class="copyright">
                &copy; <?php echo date( 'Y' ); ?> <?php bloginfo( 'name' ); ?>. All rights reserved.
            </p>
        </div>
    </div>
</footer>

<?php wp_footer(); ?>
</body>
</html>

7. STYLING CONSIDERATIONS:
   - Footer should have distinct background color
   - Widget areas should stack on mobile (responsive)
   - Proper spacing and typography
   - Copyright section should be visually separated

8. ACCESSIBILITY:
   - Proper landmark roles (footer role is implicit)
   - Proper heading hierarchy in widgets
   - Semantic HTML structure

9. WORDPRESS STANDARDS:
   - Use proper escaping (esc_html, esc_url, etc.)
   - Follow WordPress coding standards
   - Include proper indentation
   - Add inline comments for sections

IMPORTANT: The footer MUST prevent blank screens and WordPress Customizer failures:
- Include wp_footer() hook and closing tags (</body></html>) - REQUIRED
- Include visible fallback content in widget areas - prevents empty footer
- Include copyright section - adds visible content
- Close any open tags (</main> if needed) - prevents DOM breaks
- Use proper structure to ensure WordPress preview never blanks out

Create a complete, production-ready footer that will NEVER cause layout collapse or preview failures."""

        try:
            # Pass design images for footer layout reference
            php_code = self.llm_provider.generate_code(
                description, "php", context, images=self.design_images
            )

            # Very relaxed validation: auto-repair will fix any issues
            # Just check that we got some content back
            if not php_code or len(php_code.strip()) < 10:
                logger.warning("Generated footer.php is empty or too short - using fallback")
                raise ValueError("Generated footer is empty")

            # The auto-repair function will ensure footer.php has:
            # - <footer> tag (if missing, will be added)
            # - </main> closing tag (if main is open but not closed)
            # - wp_footer() hook (if missing, will be added)
            # - Proper closing tags (will be added if missing)
            # - Visible content (empty footers will be replaced)
            # - PHP syntax validation with php -l
            # If all validation fails, use template-based fallback (NOT LLM regeneration)
            from ..utils.code_validator import get_fallback_footer_php
            fallback = get_fallback_footer_php(requirements["theme_name"])
            self._validate_and_write_php(theme_dir, "footer.php", php_code, fallback_code=fallback)

        except Exception as e:
            logger.error(f"Failed to generate footer.php: {str(e)}")
            logger.info("Using template-based fallback footer (NOT LLM-generated)")
            # Use the guaranteed-safe template-based fallback
            from ..utils.code_validator import get_fallback_footer_php
            fallback = get_fallback_footer_php(requirements["theme_name"])
            self._validate_and_write_php(theme_dir, "footer.php", fallback)

    def _generate_sidebar_php(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate sidebar.php template file.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating sidebar.php")

        context = {"theme_name": requirements["theme_name"]}

        description = """Create sidebar.php template for WordPress theme.
Include:
- Check if sidebar is active
- Display dynamic sidebar
- Follow WordPress coding standards."""

        try:
            # Pass design images for sidebar layout reference
            php_code = self.llm_provider.generate_code(
                description, "php", context, images=self.design_images
            )

            fallback = get_fallback_template('sidebar.php', requirements["theme_name"])
            self._validate_and_write_php(theme_dir, "sidebar.php", php_code, fallback)

        except Exception as e:
            logger.error(f"Failed to generate sidebar.php: {str(e)}")
            fallback = get_fallback_template('sidebar.php', requirements["theme_name"])
            self._validate_and_write_php(theme_dir, "sidebar.php", fallback)

    def _generate_templates(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate additional template files based on requirements.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating template files")

        # Import rich fallback templates
        from ..fallback_templates import (
            get_rich_fallback_front_page,
            get_rich_fallback_index,
            get_rich_fallback_archive
        )

        templates_to_generate = {
            "front-page.php": "Homepage template with hero section",
            "single.php": "Single post template",
            "page.php": "Static page template",
            "archive.php": "Archive listing template with card grid",
            "search.php": "Search results template",
            "404.php": "404 error page template",
        }

        # Add custom page templates
        for page in requirements.get("pages", []):
            if page not in ["index", "single", "archive", "search", "404"]:
                template_file = f"page-{page}.php"
                templates_to_generate[template_file] = f"Custom page template for {page}"

        for template_file, description in templates_to_generate.items():
            try:
                logger.info(f"Generating {template_file}")

                context = {"theme_name": requirements["theme_name"], "template_type": template_file}

                # Special prompts for modern templates
                if template_file == "front-page.php":
                    # Import pattern library for structured guidance
                    from ..patterns import pattern_to_prompt_context, get_pattern
                    from ..design_inspiration import get_ecommerce_best_practices

                    hero_pattern = pattern_to_prompt_context('hero')
                    product_grid_pattern = pattern_to_prompt_context('product_grid')
                    cta_pattern = pattern_to_prompt_context('cta_strip')
                    feature_pattern = pattern_to_prompt_context('feature_strip')

                    full_description = f"""Create a modern, visually impressive front-page.php (homepage) template for WordPress.
This should be a COMPLETE, PRODUCTION-READY, ECOMMERCE-STYLE homepage with multiple rich sections - NOT a minimal blog layout.

DESIGN PATTERNS TO FOLLOW:

{hero_pattern}

{product_grid_pattern}

{feature_pattern}

{cta_pattern}

{get_ecommerce_best_practices()}

REQUIRED STRUCTURE:

1. START WITH get_header()

2. HERO SECTION:
<section class="hero-section">
    <div class="hero-content container">
        <h1 class="hero-title"><?php bloginfo( 'name' ); ?></h1>
        <p class="hero-description"><?php bloginfo( 'description' ); ?></p>
        <div class="hero-buttons">
            <a href="#featured" class="btn btn-primary">Explore</a>
            <a href="<?php echo esc_url( home_url( '/about' ) ); ?>" class="btn btn-secondary">Learn More</a>
        </div>
    </div>
</section>

3. FEATURED CONTENT GRID:
<section class="featured-section section">
    <div class="container">
        <h2 class="section-title">Featured Content</h2>
        <div class="grid grid-3">
            <?php
            $featured_query = new WP_Query( array(
                'posts_per_page' => 6,
                'post_status' => 'publish',
            ) );
            if ( $featured_query->have_posts() ) :
                while ( $featured_query->have_posts() ) : $featured_query->the_post();
                    ?>
                    <article class="post-card">
                        <?php if ( has_post_thumbnail() ) : ?>
                            <div class="post-thumbnail">
                                <a href="<?php the_permalink(); ?>">
                                    <?php the_post_thumbnail( 'medium' ); ?>
                                </a>
                            </div>
                        <?php endif; ?>
                        <div class="post-content">
                            <h3 class="post-title">
                                <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                            </h3>
                            <div class="post-excerpt">
                                <?php the_excerpt(); ?>
                            </div>
                            <a href="<?php the_permalink(); ?>" class="read-more">Read More</a>
                        </div>
                    </article>
                    <?php
                endwhile;
                wp_reset_postdata();
            endif;
            ?>
        </div>
    </div>
</section>

4. CALL-TO-ACTION SECTION (OPTIONAL):
<section class="cta-section section bg-primary">
    <div class="container text-center">
        <h2>Ready to Get Started?</h2>
        <p>Join thousands of satisfied users today.</p>
        <a href="<?php echo esc_url( home_url( '/contact' ) ); ?>" class="btn btn-large">Get Started</a>
    </div>
</section>

5. END WITH get_footer()

CRITICAL REQUIREMENTS:
- Use semantic HTML5 (section, article, nav)
- Add proper CSS classes for styling (.hero-section, .grid, .post-card, .btn)
- Include real, sample content (not placeholders)
- Use container class for width constraint
- Add WP_Query for featured posts
- Properly escape all output (esc_url, esc_html, esc_attr)
- Include post thumbnails, titles, excerpts
- Add call-to-action buttons
- Use WordPress functions properly
- wp_reset_postdata() after custom query

This should look professional and impressive when activated - NOT minimal or empty."""

                elif template_file == "archive.php":
                    full_description = f"""Create a modern archive.php template with styled card grid layout.

REQUIRED STRUCTURE:

1. START WITH get_header()

2. ARCHIVE HEADER:
<header class="page-header">
    <div class="container">
        <?php
        the_archive_title( '<h1 class="page-title">', '</h1>' );
        the_archive_description( '<div class="archive-description">', '</div>' );
        ?>
    </div>
</header>

3. POSTS GRID:
<div class="archive-content section">
    <div class="container">
        <?php if ( have_posts() ) : ?>
            <div class="grid grid-3 posts-grid">
                <?php while ( have_posts() ) : the_post(); ?>
                    <article id="post-<?php the_ID(); ?>" <?php post_class( 'post-card' ); ?>>
                        <?php if ( has_post_thumbnail() ) : ?>
                            <div class="post-thumbnail">
                                <a href="<?php the_permalink(); ?>">
                                    <?php the_post_thumbnail( 'medium' ); ?>
                                </a>
                            </div>
                        <?php endif; ?>
                        <div class="post-content">
                            <h2 class="post-title">
                                <a href="<?php the_permalink(); ?>"><?php the_title(); ?></a>
                            </h2>
                            <div class="post-meta">
                                <span class="post-date"><?php echo esc_html( get_the_date() ); ?></span>
                                <span class="post-author">by <?php echo esc_html( get_the_author() ); ?></span>
                            </div>
                            <div class="post-excerpt">
                                <?php the_excerpt(); ?>
                            </div>
                            <a href="<?php the_permalink(); ?>" class="read-more btn btn-outline">Read More</a>
                        </div>
                    </article>
                <?php endwhile; ?>
            </div>

            <div class="pagination">
                <?php the_posts_pagination(); ?>
            </div>
        <?php else : ?>
            <p>No posts found.</p>
        <?php endif; ?>
    </div>
</div>

4. END WITH get_footer()

CRITICAL REQUIREMENTS:
- Use semantic HTML and post_class()
- Card-based grid layout (.grid, .grid-3, .post-card)
- Include post thumbnails, titles, excerpts, meta
- Add pagination
- Properly escape all output
- Use the_archive_title() and the_archive_description()
- Include read more links styled as buttons
- Professional card design with hover effects"""

                else:
                    full_description = f"""Create {template_file} for WordPress theme.
{description}.

CRITICAL REQUIREMENTS:
1. MUST start with get_header()
2. MUST end with get_footer()
3. Use ONLY the standard WordPress loop:
   if ( have_posts() ) :
       while ( have_posts() ) : the_post();
           // Post markup
       endwhile;
   endif;
4. NEVER use undefined functions like post_loop(), get_the_meta_data() without theme prefix
5. Use standard WordPress functions: the_title(), the_content(), the_excerpt(), the_permalink(), the_date(), the_author()
6. For pagination, use the_posts_pagination() or the_posts_navigation() (NOT wp_pagenavi directly)
7. Properly escape all output with esc_html(), esc_url(), esc_attr()

Include appropriate WordPress loop and template tags.
Follow WordPress template hierarchy and coding standards."""

                # Pass design images for all template files
                php_code = self.llm_provider.generate_code(
                    full_description, "php", context, images=self.design_images
                )

                # Get rich fallback template if available
                fallback = None
                if template_file == "front-page.php":
                    fallback = get_rich_fallback_front_page(requirements["theme_name"])
                elif template_file == "archive.php":
                    fallback = get_rich_fallback_archive(requirements["theme_name"])
                else:
                    fallback = get_fallback_template(template_file, requirements["theme_name"])

                self._validate_and_write_php(theme_dir, template_file, php_code, fallback if fallback else None)
                logger.info(f"Generated {template_file} successfully")

            except Exception as e:
                logger.error(f"Failed to generate {template_file}: {str(e)}")
                # Use rich fallback template if available
                fallback = None
                if template_file == "front-page.php":
                    fallback = get_rich_fallback_front_page(requirements["theme_name"])
                    logger.info(f"Using rich fallback template for {template_file}")
                elif template_file == "archive.php":
                    fallback = get_rich_fallback_archive(requirements["theme_name"])
                    logger.info(f"Using rich fallback template for {template_file}")
                else:
                    fallback = get_fallback_template(template_file, requirements["theme_name"])

                if fallback:
                    logger.warning(f"Using fallback template for {template_file}")
                    self._validate_and_write_php(theme_dir, template_file, fallback)
                else:
                    logger.warning(f"No fallback available for {template_file}, skipping")
                    continue

    def _generate_template_parts(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Scan for get_template_part() calls and generate missing template files.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Scanning for template-parts references and generating missing files")

        # Create template-parts directory if it doesn't exist
        template_parts_dir = theme_dir / "template-parts"
        template_parts_dir.mkdir(exist_ok=True)

        # Scan all PHP files for get_template_part() calls
        template_parts_needed = set()
        php_files = list(theme_dir.rglob("*.php"))

        for php_file in php_files:
            try:
                content = php_file.read_text(encoding='utf-8')
                # Match get_template_part( 'slug', 'name' ) or get_template_part( 'slug' )
                pattern = r"get_template_part\s*\(\s*['\"]([^'\"]+)['\"](?:\s*,\s*['\"]([^'\"]+)['\"])?\s*\)"
                for match in re.finditer(pattern, content):
                    slug = match.group(1)
                    name = match.group(2) if match.group(2) else None

                    # Clean up slug (remove template-parts/ prefix if present)
                    slug_clean = slug.replace('template-parts/', '')

                    if name:
                        template_parts_needed.add((slug_clean, name))
                    else:
                        template_parts_needed.add((slug_clean, None))
            except Exception as e:
                logger.warning(f"Could not scan {php_file.name} for template parts: {e}")

        # Generate missing template parts
        for slug, name in template_parts_needed:
            if name:
                filename = f"{slug}-{name}.php"
            else:
                filename = f"{slug}.php"

            template_file = template_parts_dir / filename

            if template_file.exists():
                logger.debug(f"Template part already exists: {filename}")
                continue

            logger.info(f"Generating missing template part: {filename}")

            # Generate content based on the template part type
            if 'content' in slug:
                # Content template part
                content = f"""<?php
/**
 * Template part for displaying {name if name else 'content'}
 *
 * @package {requirements['theme_name']}
 */
?>

<article id="post-<?php the_ID(); ?>" <?php post_class(); ?>>
    <header class="entry-header">
        <?php
        if ( is_singular() ) :
            the_title( '<h1 class="entry-title">', '</h1>' );
        else :
            the_title( '<h2 class="entry-title"><a href="' . esc_url( get_permalink() ) . '" rel="bookmark">', '</a></h2>' );
        endif;
        ?>
        <div class="entry-meta">
            <span class="posted-on"><?php echo esc_html( get_the_date() ); ?></span>
            <span class="byline"> by <?php echo esc_html( get_the_author() ); ?></span>
        </div>
    </header>

    <?php if ( has_post_thumbnail() ) : ?>
        <div class="post-thumbnail">
            <?php the_post_thumbnail( 'large' ); ?>
        </div>
    <?php endif; ?>

    <div class="entry-content">
        <?php
        if ( is_singular() ) :
            the_content();
        else :
            the_excerpt();
        endif;
        ?>
    </div>

    <footer class="entry-footer">
        <?php
        if ( is_singular() ) :
            // Tags, categories, etc.
            the_tags( '<span class="tags-links">', ', ', '</span>' );
        endif;
        ?>
    </footer>
</article>
"""
            else:
                # Generic template part
                content = f"""<?php
/**
 * Template part for {slug} {name if name else ''}
 *
 * @package {requirements['theme_name']}
 */
?>

<div class="template-part-{slug}">
    <!-- Add your content here -->
    <p><?php esc_html_e( 'Template part: {slug}', '{requirements['theme_name']}' ); ?></p>
</div>
"""

            try:
                template_file.write_text(content, encoding='utf-8')
                logger.info(f"Generated template part: {filename}")
            except Exception as e:
                logger.error(f"Failed to generate template part {filename}: {e}")

        logger.info(f"Template parts generation complete ({len(template_parts_needed)} files checked)")

    def _generate_wpgen_ui_assets(self, theme_dir: Path) -> None:
        """Generate always-on UI enhancement assets (CSS/JS for transitions and mobile nav).

        Args:
            theme_dir: Theme directory path
        """
        logger.info("Generating wpgen-ui assets (smooth transitions, mobile nav)")

        # Create assets directories
        assets_dir = theme_dir / "assets"
        css_dir = assets_dir / "css"
        js_dir = assets_dir / "js"
        css_dir.mkdir(parents=True, exist_ok=True)
        js_dir.mkdir(parents=True, exist_ok=True)

        # Generate CSS for smooth transitions and mobile navigation
        css_content = """/* WPGen UI Enhancements - Always On */

/* Smooth page transitions */
body {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

body.wpgen-loaded {
    opacity: 1;
}

/* Smooth internal link transitions */
a {
    transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
}

/* Mobile-first, thumb-friendly navigation */
@media (max-width: 768px) {
    /* Minimum tap target size: 44x44px for touch */
    nav a,
    button,
    .menu-item a,
    .nav-link {
        min-height: 44px;
        min-width: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1rem;
    }

    /* Mobile menu toggle button */
    .mobile-menu-toggle {
        min-height: 44px;
        min-width: 44px;
        cursor: pointer;
        background: transparent;
        border: none;
        padding: 0.75rem;
        font-size: 1.5rem;
    }

    /* Mobile menu - hidden by default */
    .mobile-menu {
        display: none;
        flex-direction: column;
        width: 100%;
    }

    .mobile-menu.active {
        display: flex;
    }
}

/* Responsive typography and spacing */
@media (max-width: 768px) {
    body {
        font-size: 16px; /* Minimum for mobile readability */
    }

    /* Generous touch padding */
    input[type="submit"],
    input[type="button"],
    .button,
    .btn {
        min-height: 44px;
        padding: 0.75rem 1.5rem;
    }
}
"""

        css_file = css_dir / "wpgen-ui.css"
        css_file.write_text(css_content, encoding="utf-8")

        # Generate JS for page transitions and mobile menu toggle
        js_content = """/* WPGen UI Enhancements - Always On */
(function() {
    'use strict';

    // Smooth page load transition
    document.addEventListener('DOMContentLoaded', function() {
        document.body.classList.add('wpgen-loaded');
    });

    // Smooth page navigation (prefetch and fade)
    var links = document.querySelectorAll('a[href^="' + window.location.origin + '"]');
    links.forEach(function(link) {
        link.addEventListener('click', function(e) {
            var href = this.getAttribute('href');
            // Skip anchors, external links, and special links
            if (href.indexOf('#') === 0 || this.getAttribute('target') === '_blank') {
                return;
            }
            e.preventDefault();
            document.body.classList.remove('wpgen-loaded');
            setTimeout(function() {
                window.location.href = href;
            }, 300);
        });
    });

    // Mobile menu toggle
    var toggleBtn = document.querySelector('.mobile-menu-toggle');
    var mobileNav = document.querySelector('.main-navigation');

    if (toggleBtn && mobileNav) {
        toggleBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            mobileNav.classList.toggle('active');
            this.setAttribute('aria-expanded',
                mobileNav.classList.contains('active') ? 'true' : 'false'
            );
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!toggleBtn.contains(e.target) && !mobileNav.contains(e.target)) {
                mobileNav.classList.remove('active');
                toggleBtn.setAttribute('aria-expanded', 'false');
            }
        });

        // Close menu on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && mobileNav.classList.contains('active')) {
                mobileNav.classList.remove('active');
                toggleBtn.setAttribute('aria-expanded', 'false');
                toggleBtn.focus();
            }
        });
    }
})();
"""

        js_file = js_dir / "wpgen-ui.js"
        js_file.write_text(js_content, encoding="utf-8")

        logger.info("Generated wpgen-ui assets successfully")

    def _generate_base_layout_css(self, theme_dir: Path) -> None:
        """Generate base layout CSS file with structural styles for proper theme presentation.

        Args:
            theme_dir: Theme directory path
        """
        logger.info("Generating base layout CSS (assets/css/style.css)")

        # Create assets/css directory if it doesn't exist
        css_dir = theme_dir / "assets" / "css"
        css_dir.mkdir(parents=True, exist_ok=True)

        # Generate base layout styles with modern CSS
        css_content = """/* Modern Base Layout Styles
 * Production-ready structural and layout styles with modern CSS features
 * Includes: CSS Variables, Grid System, Button Styles, Card Components, Animations
 */

/* ===========================
   CSS CUSTOM PROPERTIES
   =========================== */
:root {
    /* Colors */
    --color-primary: #2563eb;
    --color-secondary: #7c3aed;
    --color-accent: #06b6d4;
    --color-background: #ffffff;
    --color-surface: #f8fafc;
    --color-text: #1e293b;
    --color-text-muted: #64748b;
    --color-border: #e2e8f0;
    --color-hover: #1e40af;

    /* Spacing Scale */
    --spacing-xs: 0.25rem;    /* 4px */
    --spacing-sm: 0.5rem;     /* 8px */
    --spacing-md: 1rem;       /* 16px */
    --spacing-lg: 1.5rem;     /* 24px */
    --spacing-xl: 2rem;       /* 32px */
    --spacing-2xl: 3rem;      /* 48px */
    --spacing-3xl: 4rem;      /* 64px */
    --spacing-4xl: 6rem;      /* 96px */

    /* Typography */
    --font-primary: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    --font-headings: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;

    /* Layout */
    --container-max: 1200px;
    --content-max: 800px;
    --header-height: 80px;
    --border-radius: 0.5rem;
    --border-radius-sm: 0.25rem;
    --border-radius-lg: 1rem;

    /* Transitions */
    --transition-fast: 150ms ease;
    --transition-base: 300ms ease;
    --transition-slow: 500ms ease;

    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-base: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
}

/* ===========================
   MODERN CSS RESET
   =========================== */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    scroll-behavior: smooth;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    margin: 0;
    font-family: var(--font-primary);
    font-size: 1rem;
    line-height: 1.6;
    color: var(--color-text);
    background: var(--color-background);
}

img, picture, video, canvas, svg {
    display: block;
    max-width: 100%;
    height: auto;
}

input, button, textarea, select {
    font: inherit;
}

p, h1, h2, h3, h4, h5, h6 {
    overflow-wrap: break-word;
}

a {
    color: var(--color-primary);
    text-decoration: none;
    transition: color var(--transition-fast);
}

a:hover {
    color: var(--color-hover);
}

/* ===========================
   TYPOGRAPHY
   =========================== */
h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-headings);
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: var(--spacing-md);
}

h1 { font-size: clamp(2rem, 5vw, 3rem); }
h2 { font-size: clamp(1.75rem, 4vw, 2.5rem); }
h3 { font-size: clamp(1.5rem, 3vw, 2rem); }
h4 { font-size: 1.5rem; }
h5 { font-size: 1.25rem; }
h6 { font-size: 1rem; }

p {
    margin-bottom: var(--spacing-md);
}

/* ===========================
   CONTAINER & LAYOUT
   =========================== */
.container {
    max-width: var(--container-max);
    margin-left: auto;
    margin-right: auto;
    padding-left: var(--spacing-lg);
    padding-right: var(--spacing-lg);
}

.content {
    max-width: var(--content-max);
    margin-left: auto;
    margin-right: auto;
}

.section {
    padding: var(--spacing-3xl) 0;
}

/* ===========================
   GRID SYSTEM
   =========================== */
.grid {
    display: grid;
    gap: var(--spacing-xl);
}

.grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 300px), 1fr));
}

.grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 280px), 1fr));
}

.grid-4 {
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
}

/* ===========================
   FLEXBOX UTILITIES
   =========================== */
.flex {
    display: flex;
}

.flex-center {
    display: flex;
    align-items: center;
    justify-content: center;
}

.flex-between {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.flex-column {
    display: flex;
    flex-direction: column;
}

/* ===========================
   BUTTON STYLES
   =========================== */
.btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    text-align: center;
    border: 2px solid transparent;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-base);
    text-decoration: none;
}

.btn-primary {
    background: var(--color-primary);
    color: white;
}

.btn-primary:hover {
    background: var(--color-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--color-secondary);
    color: white;
}

.btn-secondary:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}

.btn-outline {
    background: transparent;
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.btn-outline:hover {
    background: var(--color-primary);
    color: white;
}

.btn-large {
    padding: 1rem 2rem;
    font-size: 1.125rem;
}

/* ===========================
   CARD COMPONENTS
   =========================== */
.post-card,
.product-card,
.promo-card {
    background: var(--color-background);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-base);
    transition: all var(--transition-base);
    height: 100%;
    display: flex;
    flex-direction: column;
}

.post-card:hover,
.product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.post-thumbnail,
.product-thumbnail {
    width: 100%;
    aspect-ratio: 16 / 9;
    overflow: hidden;
    background: var(--color-surface);
}

.post-thumbnail img,
.product-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-slow);
}

.post-card:hover .post-thumbnail img,
.product-card:hover .product-thumbnail img {
    transform: scale(1.05);
}

.post-content,
.product-content {
    padding: var(--spacing-lg);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.post-title,
.product-title {
    margin: 0 0 var(--spacing-sm);
    font-size: 1.25rem;
    line-height: 1.3;
}

.post-title a,
.product-title a {
    color: var(--color-text);
}

.post-title a:hover,
.product-title a:hover {
    color: var(--color-primary);
}

.post-meta {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-md);
}

.post-excerpt {
    color: var(--color-text);
    margin-bottom: var(--spacing-md);
    flex-grow: 1;
}

.read-more {
    margin-top: auto;
}

/* ===========================
   HERO SECTION
   =========================== */
.hero-section {
    min-height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: white;
    text-align: center;
    padding: var(--spacing-4xl) var(--spacing-lg);
    position: relative;
    overflow: hidden;
}

.hero-content {
    position: relative;
    z-index: 1;
}

.hero-title {
    font-size: clamp(2.5rem, 6vw, 4rem);
    margin-bottom: var(--spacing-lg);
    color: white;
}

.hero-description {
    font-size: clamp(1.125rem, 2vw, 1.5rem);
    margin-bottom: var(--spacing-2xl);
    opacity: 0.95;
}

.hero-buttons {
    display: flex;
    gap: var(--spacing-md);
    justify-content: center;
    flex-wrap: wrap;
}

/* ===========================
   HEADER
   =========================== */
.site-header {
    background: var(--color-background);
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing-md) 0;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--spacing-md);
}

.site-branding {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.custom-logo-link img {
    max-height: 60px;
    width: auto;
}

.site-title {
    margin: 0;
    font-size: 1.5rem;
}

.site-title a {
    color: var(--color-text);
}

.site-title a:hover {
    color: var(--color-primary);
}

.site-description {
    margin: 0;
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.mobile-menu-toggle {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--spacing-sm);
}

.main-navigation ul {
    list-style: none;
    display: flex;
    gap: var(--spacing-xl);
    margin: 0;
    padding: 0;
}

.main-navigation a {
    color: var(--color-text);
    font-weight: 500;
    padding: var(--spacing-sm) 0;
}

.main-navigation a:hover {
    color: var(--color-primary);
}

/* ===========================
   MAIN CONTENT
   =========================== */
.site-main {
    min-height: 60vh;
}

article {
    margin-bottom: var(--spacing-3xl);
}

.entry-header {
    margin-bottom: var(--spacing-xl);
}

.entry-title {
    margin-bottom: var(--spacing-md);
}

.entry-content {
    line-height: 1.7;
}

.entry-content > * + * {
    margin-top: var(--spacing-md);
}

/* ===========================
   FOOTER
   =========================== */
.site-footer {
    background: var(--color-surface);
    border-top: 1px solid var(--color-border);
    margin-top: var(--spacing-4xl);
}

.footer-widgets {
    padding: var(--spacing-3xl) 0;
}

.footer-widgets-inner {
    display: grid;
    gap: var(--spacing-2xl);
}

.footer-widget-area h2,
.footer-widget-area h3 {
    font-size: 1.125rem;
    margin-bottom: var(--spacing-md);
}

.site-info {
    background: var(--color-background);
    border-top: 1px solid var(--color-border);
    padding: var(--spacing-xl) 0;
}

.site-info-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--spacing-md);
}

.copyright {
    margin: 0;
    color: var(--color-text-muted);
    font-size: 0.875rem;
}

/* ===========================
   UTILITY CLASSES
   =========================== */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.text-uppercase { text-transform: uppercase; }
.font-bold { font-weight: 700; }
.font-medium { font-weight: 500; }

.bg-primary { background: var(--color-primary); color: white; }
.bg-secondary { background: var(--color-secondary); color: white; }
.bg-light { background: var(--color-surface); }
.bg-dark { background: var(--color-text); color: white; }

.hidden { display: none; }
.block { display: block; }

/* Spacing utilities */
.mt-1 { margin-top: var(--spacing-sm); }
.mt-2 { margin-top: var(--spacing-md); }
.mt-3 { margin-top: var(--spacing-lg); }
.mt-4 { margin-top: var(--spacing-xl); }

.mb-1 { margin-bottom: var(--spacing-sm); }
.mb-2 { margin-bottom: var(--spacing-md); }
.mb-3 { margin-bottom: var(--spacing-lg); }
.mb-4 { margin-bottom: var(--spacing-xl); }

.py-1 { padding-top: var(--spacing-sm); padding-bottom: var(--spacing-sm); }
.py-2 { padding-top: var(--spacing-md); padding-bottom: var(--spacing-md); }
.py-3 { padding-top: var(--spacing-lg); padding-bottom: var(--spacing-lg); }
.py-4 { padding-top: var(--spacing-xl); padding-bottom: var(--spacing-xl); }

.px-1 { padding-left: var(--spacing-sm); padding-right: var(--spacing-sm); }
.px-2 { padding-left: var(--spacing-md); padding-right: var(--spacing-md); }
.px-3 { padding-left: var(--spacing-lg); padding-right: var(--spacing-lg); }
.px-4 { padding-left: var(--spacing-xl); padding-right: var(--spacing-xl); }

/* ===========================
   WORDPRESS CORE CLASSES
   =========================== */
.alignleft {
    float: left;
    margin-right: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
}

.alignright {
    float: right;
    margin-left: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
}

.aligncenter {
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.alignwide {
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
}

.alignfull {
    max-width: 100%;
    width: 100vw;
    margin-left: calc(50% - 50vw);
}

.wp-caption {
    max-width: 100%;
}

.wp-caption-text {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-align: center;
    margin-top: var(--spacing-sm);
    padding: var(--spacing-sm);
}

.gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-md);
}

.sticky {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-md);
}

/* ===========================
   ACCESSIBILITY
   =========================== */
a:focus,
button:focus,
input:focus,
textarea:focus,
select:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
}

.screen-reader-text {
    border: 0;
    clip: rect(1px, 1px, 1px, 1px);
    clip-path: inset(50%);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
    word-wrap: normal !important;
}

/* ===========================
   RESPONSIVE DESIGN
   =========================== */
@media (max-width: 1024px) {
    .container {
        padding-left: var(--spacing-md);
        padding-right: var(--spacing-md);
    }
}

@media (max-width: 768px) {
    .mobile-menu-toggle {
        display: block;
    }

    .main-navigation {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        background: var(--color-background);
        padding: var(--spacing-lg);
        transform: translateX(-100%);
        transition: transform var(--transition-base);
        box-shadow: var(--shadow-lg);
    }

    .main-navigation.active {
        transform: translateX(0);
    }

    .main-navigation ul {
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .grid-2,
    .grid-3,
    .grid-4 {
        grid-template-columns: 1fr;
    }

    .hero-section {
        min-height: 400px;
        padding: var(--spacing-2xl) var(--spacing-md);
    }

    .hero-buttons {
        flex-direction: column;
        width: 100%;
    }

    .hero-buttons .btn {
        width: 100%;
    }

    .footer-widgets-inner.grid-3,
    .footer-widgets-inner.grid-4 {
        grid-template-columns: 1fr;
    }

    .site-info-inner {
        flex-direction: column;
        text-align: center;
    }
}

@media (min-width: 769px) and (max-width: 1024px) {
    .grid-4 {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* ===========================
   ANIMATIONS
   =========================== */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn var(--transition-base) ease-out;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.slide-in-left {
    animation: slideInLeft var(--transition-base) ease-out;
}

/* ===========================
   WOOCOMMERCE SUPPORT
   =========================== */
.woocommerce ul.products {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-xl);
    list-style: none;
    margin: 0;
    padding: 0;
}

.woocommerce ul.products li.product {
    background: var(--color-background);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-base);
    transition: all var(--transition-base);
}

.woocommerce ul.products li.product:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.woocommerce ul.products li.product img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
}

.woocommerce ul.products li.product .price {
    color: var(--color-primary);
    font-weight: 700;
    font-size: 1.25rem;
}

.woocommerce .button,
.woocommerce button.button {
    background: var(--color-primary);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    border: none;
    cursor: pointer;
    transition: all var(--transition-base);
}

.woocommerce .button:hover,
.woocommerce button.button:hover {
    background: var(--color-hover);
    transform: translateY(-2px);
}
"""

        css_file = css_dir / "style.css"
        css_file.write_text(css_content, encoding="utf-8")
        logger.info("Generated base layout CSS successfully")

    def _generate_optional_features(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate optional feature assets based on requirements.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements dict
        """
        # Check for WooCommerce support
        integrations = requirements.get("integrations", [])
        description = requirements.get("description", "").lower()

        # WooCommerce support
        if "woocommerce" in integrations or "woocommerce" in description:
            logger.info("Adding WooCommerce support")
            self._generate_woocommerce_support(theme_dir)

        # Custom Gutenberg blocks
        # Check for block keywords in description or features
        blocks_to_create = []
        if "featured_products" in description or "featured products" in description:
            blocks_to_create.append("featured_products")
        if "lifestyle_image" in description or "lifestyle image" in description:
            blocks_to_create.append("lifestyle_image")
        if "promo_banner" in description or "promo banner" in description:
            blocks_to_create.append("promo_banner")

        if blocks_to_create:
            logger.info(f"Adding custom Gutenberg blocks: {', '.join(blocks_to_create)}")
            self._generate_gutenberg_blocks(theme_dir, blocks_to_create)

        # Dark mode toggle
        if "dark" in description and "mode" in description or "dark/light" in description:
            logger.info("Adding dark mode toggle")
            self._generate_dark_mode(theme_dir, requirements)

        # Animated preloader
        if "preloader" in description or "loading logo" in description or "animated loading" in description:
            logger.info("Adding animated preloader")
            self._generate_preloader(theme_dir, requirements)

    def _generate_woocommerce_support(self, theme_dir: Path) -> None:
        """Add WooCommerce support files and templates."""
        # Create woocommerce.php template
        woo_template = """<?php
/**
 * WooCommerce template
 *
 * This template is used for all WooCommerce pages
 */

get_header();

if ( function_exists( 'woocommerce' ) ) :
    ?>
    <div class="woocommerce-wrapper">
        <?php woocommerce_content(); ?>
    </div>
    <?php
endif;

get_footer();
"""
        woo_file = theme_dir / "woocommerce.php"
        woo_file.write_text(woo_template, encoding="utf-8")
        logger.info("Created woocommerce.php template")

    def _generate_gutenberg_blocks(self, theme_dir: Path, blocks: list[str]) -> None:
        """Generate custom Gutenberg blocks scaffolding with React idempotency."""
        blocks_dir = theme_dir / "blocks"
        blocks_dir.mkdir(exist_ok=True)

        block_configs = {
            "featured_products": {
                "title": "Featured Products",
                "icon": "products",
                "category": "widgets"
            },
            "lifestyle_image": {
                "title": "Lifestyle Image",
                "icon": "format-image",
                "category": "media"
            },
            "promo_banner": {
                "title": "Promo Banner",
                "icon": "megaphone",
                "category": "widgets"
            }
        }

        for block_name in blocks:
            if block_name not in block_configs:
                continue

            config = block_configs[block_name]
            block_dir = blocks_dir / block_name
            block_dir.mkdir(exist_ok=True)

            # Normalize category to valid WordPress core category
            normalized_category = normalize_block_category(config["category"])
            if normalized_category != config["category"]:
                logger.info(f"Normalized block category '{config['category']}' to '{normalized_category}'")

            # Create block.json
            block_json = {
                "$schema": "https://schemas.wp.org/trunk/block.json",
                "apiVersion": 2,
                "name": f"wpgen/{block_name}",
                "title": config["title"],
                "category": normalized_category,  # Use normalized category
                "icon": config["icon"],
                "description": f"Display {config['title'].lower()}",
                "supports": {
                    "html": False
                },
                "textdomain": "wpgen",
                "editorScript": "file:./index.js",
                "editorStyle": "file:./editor.css",
                "style": "file:./style.css"
            }

            import json
            block_json_file = block_dir / "block.json"
            block_json_file.write_text(json.dumps(block_json, indent=2), encoding="utf-8")

            # Create idempotent React mount pattern for blocks
            # This prevents React error #299 (double mount) in Customizer preview
            index_js = f"""import {{ registerBlockType }} from '@wordpress/blocks';
import {{ createElement }} from '@wordpress/element';

// Idempotent block registration - prevents double mount in Customizer
const blockName = 'wpgen/{block_name}';

const BlockEdit = () => {{
    return createElement(
        'div',
        {{ className: 'wp-block-wpgen-{block_name}' }},
        '{config['title']} Block'
    );
}};

const BlockSave = () => {{
    return createElement(
        'div',
        {{ className: 'wp-block-wpgen-{block_name}' }},
        '{config['title']}'
    );
}};

registerBlockType(blockName, {{
    edit: BlockEdit,
    save: BlockSave
}});
"""
            (block_dir / "index.js").write_text(index_js, encoding="utf-8")

            # Create empty CSS files
            (block_dir / "style.css").write_text(f"/* {config['title']} block styles */\n", encoding="utf-8")
            (block_dir / "editor.css").write_text(f"/* {config['title']} editor styles */\n", encoding="utf-8")

            logger.info(f"Created Gutenberg block: {block_name}")

    def _generate_dark_mode(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate dark mode toggle CSS and JS."""
        assets_dir = theme_dir / "assets"
        css_dir = assets_dir / "css"
        js_dir = assets_dir / "js"

        # CSS for dark mode
        dark_css = """/* Dark Mode Support */
:root {
    --bg-primary: #ffffff;
    --text-primary: #1a202c;
    --bg-secondary: #f7fafc;
    --text-secondary: #4a5568;
}

[data-theme="dark"] {
    --bg-primary: #1a202c;
    --text-primary: #f7fafc;
    --bg-secondary: #2d3748;
    --text-secondary: #cbd5e0;
}

body {
    background-color: var(--bg-primary);
    color: var(--text-primary);
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* Dark mode toggle button */
.dark-mode-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--bg-secondary);
    border: 2px solid var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    z-index: 1000;
}

@media (prefers-color-scheme: dark) {
    :root:not([data-theme="light"]) {
        --bg-primary: #1a202c;
        --text-primary: #f7fafc;
        --bg-secondary: #2d3748;
        --text-secondary: #cbd5e0;
    }
}
"""
        (css_dir / "dark-mode.css").write_text(dark_css, encoding="utf-8")

        # JS for dark mode toggle
        dark_js = """(function() {
    'use strict';

    // Check for saved theme preference or default to system preference
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (prefersDark ? 'dark' : 'light');

    document.documentElement.setAttribute('data-theme', theme);

    // Create toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'dark-mode-toggle';
    toggleBtn.setAttribute('aria-label', 'Toggle dark mode');
    toggleBtn.innerHTML = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    document.body.appendChild(toggleBtn);

    toggleBtn.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        this.innerHTML = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    });
})();
"""
        (js_dir / "dark-mode.js").write_text(dark_js, encoding="utf-8")
        logger.info("Generated dark mode toggle")

    def _generate_preloader(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate animated preloader HTML/CSS/JS."""
        assets_dir = theme_dir / "assets"
        css_dir = assets_dir / "css"
        js_dir = assets_dir / "js"

        # CSS for preloader
        preloader_css = """/* Animated Preloader */
.wpgen-preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
}

.wpgen-preloader.fade-out {
    opacity: 0;
    pointer-events: none;
}

.wpgen-preloader-logo {
    width: 80px;
    height: 80px;
    border: 4px solid #f3f4f6;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: wpgen-spin 1s linear infinite;
}

@keyframes wpgen-spin {
    to { transform: rotate(360deg); }
}
"""
        (css_dir / "preloader.css").write_text(preloader_css, encoding="utf-8")

        # JS for preloader
        preloader_js = """(function() {
    'use strict';

    // Create preloader element
    const preloader = document.createElement('div');
    preloader.className = 'wpgen-preloader';
    preloader.innerHTML = '<div class="wpgen-preloader-logo"></div>';
    document.body.insertBefore(preloader, document.body.firstChild);

    // Hide preloader when page is loaded
    window.addEventListener('load', function() {
        setTimeout(function() {
            preloader.classList.add('fade-out');
            setTimeout(function() {
                preloader.remove();
            }, 500);
        }, 500);
    });

    // Fallback: hide after 3 seconds max
    setTimeout(function() {
        if (preloader.parentNode) {
            preloader.classList.add('fade-out');
            setTimeout(function() {
                if (preloader.parentNode) {
                    preloader.remove();
                }
            }, 500);
        }
    }, 3000);
})();
"""
        (js_dir / "preloader.js").write_text(preloader_js, encoding="utf-8")
        logger.info("Generated animated preloader")

    def _generate_readme(self, theme_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate README.md for the theme.

        Args:
            theme_dir: Theme directory path
            requirements: Theme requirements
        """
        logger.info("Generating README.md")

        readme_content = f"""# {requirements['theme_display_name']}

{requirements['description']}

## Description

This WordPress theme was automatically generated using WPGen.

## Features

{chr(10).join(f'- {feature}' for feature in requirements.get('features', []))}

## Installation

1. Download the theme ZIP file
2. In WordPress admin, go to Appearance > Themes > Add New > Upload Theme
3. Choose the ZIP file and click Install Now
4. After installation, click Activate

## Development

This theme was generated with the following specifications:

- **Color Scheme**: {requirements.get('color_scheme', 'default')}
- **Layout**: {requirements.get('layout', 'full-width')}
- **Pages**: {', '.join(requirements.get('pages', []))}

## Customization

You can customize this theme using:

1. WordPress Customizer (Appearance > Customize)
2. Editing the theme files directly
3. Using a child theme (recommended for major modifications)

## Support

For issues and questions:
- Check the [WordPress Codex](https://codex.wordpress.org/)
- Visit [WordPress Support Forums](https://wordpress.org/support/)

## License

This theme is licensed under {self.config.get('license', 'GPL-2.0-or-later')}.

## Credits

- Generated by: WPGen
- Generated on: {datetime.now().strftime('%Y-%m-%d')}
"""

        readme_file = theme_dir / "README.md"
        readme_file.write_text(readme_content, encoding="utf-8")
        logger.info("Generated README.md successfully")

    def _generate_gitignore(self, theme_dir: Path) -> None:
        """Generate .gitignore file for the theme.

        Args:
            theme_dir: Theme directory path
        """
        logger.info("Generating .gitignore")

        gitignore_content = """# WordPress
wp-config.php
wp-content/uploads/
wp-content/cache/
wp-content/backup-db/

# Theme development
node_modules/
*.sass-cache/
.DS_Store
Thumbs.db
*.log

# IDE
.idea/
.vscode/
*.swp
*.swo
*~

# Build files
dist/
build/
"""

        gitignore_file = theme_dir / ".gitignore"
        gitignore_file.write_text(gitignore_content, encoding="utf-8")
        logger.info("Generated .gitignore successfully")

    def _generate_wp_config(self, output_dir: Path, requirements: dict[str, Any]) -> None:
        """Generate sample wp-config.php file.

        Args:
            output_dir: Output directory (parent of theme dir)
            requirements: Theme requirements
        """
        logger.info("Generating wp-config-sample.php")

        wp_config_content = """<?php
/**
 * Sample WordPress Configuration File
 *
 * This file contains sample configuration for WordPress.
 * Copy this file to 'wp-config.php' and fill in the values.
 *
 * @package WordPress
 */

// ** Database settings ** //
define( 'DB_NAME', 'database_name_here' );
define( 'DB_USER', 'username_here' );
define( 'DB_PASSWORD', 'password_here' );
define( 'DB_HOST', 'localhost' );
define( 'DB_CHARSET', 'utf8' );
define( 'DB_COLLATE', '' );

// ** Authentication unique keys and salts ** //
// Get these from: https://api.wordpress.org/secret-key/1.1/salt/
define( 'AUTH_KEY',         'put your unique phrase here' );
define( 'SECURE_AUTH_KEY',  'put your unique phrase here' );
define( 'LOGGED_IN_KEY',    'put your unique phrase here' );
define( 'NONCE_KEY',        'put your unique phrase here' );
define( 'AUTH_SALT',        'put your unique phrase here' );
define( 'SECURE_AUTH_SALT', 'put your unique phrase here' );
define( 'LOGGED_IN_SALT',   'put your unique phrase here' );
define( 'NONCE_SALT',       'put your unique phrase here' );

// ** WordPress database table prefix ** //
$table_prefix = 'wp_';

// ** WordPress debugging mode ** //
define( 'WP_DEBUG', false );

/* That's all, stop editing! Happy publishing. */

if ( ! defined( 'ABSPATH' ) ) {
    define( 'ABSPATH', __DIR__ . '/' );
}

require_once ABSPATH . 'wp-settings.php';
"""

        wp_config_file = output_dir / "wp-config-sample.php"
        wp_config_file.write_text(wp_config_content, encoding="utf-8")
        logger.info("Generated wp-config-sample.php successfully")
